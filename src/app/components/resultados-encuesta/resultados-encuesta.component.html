<section class="pagina-informes">
  
  <header class="header-actions">
    <div class="acciones-izq">
      <button mat-flat-button color="primary" routerLink="/seleccion-estadisticas">
        <mat-icon>arrow_back</mat-icon> Volver
      </button>
      
      <!-- FILTRO -->
      <mat-form-field appearance="outline" class="filtro-especialista">
        <mat-label>Filtrar por Especialista</mat-label>
        <mat-select [(value)]="filtroEspecialista" (selectionChange)="cargarDatos()">
          <mat-option [value]="null">Todos</mat-option>
          <mat-option *ngFor="let esp of especialistas" [value]="esp.id">
            {{ esp.apellido }}, {{ esp.nombre }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- BOT√ìN DESCARGAR PDF -->
    <button mat-flat-button color="accent" (click)="descargarPDF()" [disabled]="cargando">
      <mat-icon>picture_as_pdf</mat-icon>
      Descargar Reporte
    </button>
  </header>

  <h1 class="titulo-pag">Resultados de Encuestas</h1>

  <div *ngIf="cargando" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <!-- AGREGADO id="dashboard-content" PARA LA CAPTURA -->
  <div class="dashboard-grid" *ngIf="!cargando" id="dashboard-content">
    
    <div class="kpi-row">
      <mat-card class="kpi-card">
        <div class="kpi-icon">‚≠ê</div>
        <div class="kpi-value">{{ promedioEstrellas }} / 5</div>
        <div class="kpi-label">Calificaci√≥n Promedio</div>
      </mat-card>

      <mat-card class="kpi-card">
        <div class="kpi-icon">üëç</div>
        <div class="kpi-value">{{ porcentajeRecomendacion }}%</div>
        <div class="kpi-label">Recomiendan al Especialista</div>
      </mat-card>

      <mat-card class="kpi-card">
        <div class="kpi-icon">‚è∞</div>
        <div class="kpi-value">{{ promedioPuntualidad }}%</div>
        <div class="kpi-label">Puntualidad Percibida</div>
      </mat-card>
    </div>

    <div class="content-row">
      
      <mat-card class="chart-panel">
        <h3>Distribuci√≥n de Calificaciones</h3>
        <apx-chart
          [series]="chartSeries"
          [chart]="chartOptions.chart"
          [xaxis]="chartOptions.xaxis"
          [yaxis]="chartOptions.yaxis"
          [colors]="chartOptions.colors"
          [plotOptions]="chartOptions.plotOptions"
          [tooltip]="chartOptions.tooltip"
          [dataLabels]="chartOptions.dataLabels"
          [grid]="chartOptions.grid">
        </apx-chart>
      </mat-card>

      <mat-card class="comments-panel">
        <h3>Comentarios Recientes ({{ comentarios.length }})</h3>
        
        <div class="comments-list" *ngIf="comentarios.length > 0; else noComments">
          <div class="comment-item" *ngFor="let c of comentarios">
            <div class="comment-header">
              <span class="stars">
                <ng-container *ngFor="let _ of [].constructor(c.estrellas)">‚òÖ</ng-container>
              </span>
              <span class="date">{{ c.fecha_respuesta | date:'shortDate' }}</span>
            </div>
            <p class="comment-text">"{{ c.comentario }}"</p>
            <div class="comment-meta">
              <span *ngIf="c.especialista">Dr/a. {{ c.especialista.apellido }}</span>
              <span class="badge" *ngIf="c.respuesta_radio === 'si'">Recomendado</span>
            </div>
          </div>
        </div>

        <ng-template #noComments>
          <p class="muted">No hay comentarios registrados con estos filtros.</p>
        </ng-template>
      </mat-card>

    </div>
  </div>
</section>










