<mat-card class="wrap">
  <mat-card-header>
    <mat-card-title>Mis Turnos (Especialista)</mat-card-title>
  </mat-card-header>

  <div class="filter">
    <mat-form-field appearance="outline" class="w">
      <mat-label>Filtra por especialidad o paciente</mat-label>
      <input matInput #q (keyup)="aplicarFiltro(q.value)" placeholder="Buscar…">
      <button mat-icon-button matSuffix aria-label="Limpiar" *ngIf="dataSource.filter" (click)="q.value=''; aplicarFiltro('')">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
  </div>

  <table mat-table [dataSource]="dataSource" class="mat-elevation-z2">
    <!-- ID -->
    <ng-container matColumnDef="id">
      <th mat-header-cell *matHeaderCellDef>#</th>
      <td mat-cell *matCellDef="let t">{{ t.id | slice:0:8 }}</td>
    </ng-container>

    <!-- Fecha -->
    <ng-container matColumnDef="fecha">
      <th mat-header-cell *matHeaderCellDef>Fecha</th>
      <td mat-cell *matCellDef="let t">{{ t.fechaISO | date:'dd/MM/yyyy' }}</td>
    </ng-container>

    <!-- Hora -->
    <ng-container matColumnDef="hora">
      <th mat-header-cell *matHeaderCellDef>Hora</th>
      <td mat-cell *matCellDef="let t">{{ t.hora }}</td>
    </ng-container>

    <!-- Especialidad -->
    <ng-container matColumnDef="especialidad">
      <th mat-header-cell *matHeaderCellDef>Especialidad</th>
      <td mat-cell *matCellDef="let t">{{ t.especialidad }}</td>
    </ng-container>

    <!-- Paciente -->
    <ng-container matColumnDef="paciente">
      <th mat-header-cell *matHeaderCellDef>Paciente</th>
      <td mat-cell *matCellDef="let t">{{ t.paciente }}</td>
    </ng-container>

    <!-- Estado -->
    <ng-container matColumnDef="estado">
      <th mat-header-cell *matHeaderCellDef>Estado</th>
      <td mat-cell *matCellDef="let t">
        <span class="chip"
          [class.ok]="t.estado==='realizado'"
          [class.warn]="t.estado==='aceptado'"
          [class.bad]="t.estado==='cancelado' || t.estado==='rechazado'">
          {{ t.estado | titlecase }}
        </span>
      </td>
    </ng-container>

    <!-- Acciones -->
    <ng-container matColumnDef="acciones">
      <th mat-header-cell *matHeaderCellDef>Acciones</th>
      <td mat-cell *matCellDef="let t">
        <button mat-icon-button color="primary"
          *ngIf="t.estado!=='realizado' && t.estado!=='cancelado' && t.estado!=='rechazado'"
          (click)="aceptarTurno(t)" matTooltip="Aceptar">
          <mat-icon>check_circle</mat-icon>
        </button>

        <button mat-icon-button color="warn"
          *ngIf="t.estado!=='aceptado' && t.estado!=='realizado' && t.estado!=='cancelado'"
          (click)="rechazarTurno(t)" matTooltip="Rechazar">
          <mat-icon>block</mat-icon>
        </button>

        <button mat-icon-button color="warn"
          *ngIf="t.estado!=='aceptado' && t.estado!=='realizado' && t.estado!=='rechazado'"
          (click)="cancelarTurno(t)" matTooltip="Cancelar">
          <mat-icon>cancel</mat-icon>
        </button>

        <button mat-icon-button color="accent"
          *ngIf="t.estado==='aceptado'"
          (click)="finalizarTurno(t)" matTooltip="Finalizar (dejar reseña)">
          <mat-icon>event_available</mat-icon>
        </button>

        <button mat-icon-button color="primary"
          *ngIf="t.resenaEspecialista"
          (click)="verResena(t)" matTooltip="Ver reseña">
          <mat-icon>visibility</mat-icon>
        </button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>

  <p *ngIf="!dataSource.data.length" class="no-data">No se encontraron turnos.</p>
</mat-card>

<!-- Diálogo genérico de confirmación -->
<ng-template #confirmDialog let-data>
  <h2 mat-dialog-title>Confirmar</h2>
  <mat-dialog-content>{{ data?.message }}</mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close="false">Cancelar</button>
    <button mat-raised-button color="primary" [mat-dialog-close]="true">Aceptar</button>
  </mat-dialog-actions>
</ng-template>
