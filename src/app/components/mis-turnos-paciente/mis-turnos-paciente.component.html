<mat-card class="mis-shell mat-elevation-z6" appElevateOnHover>

  <!-- <header class="hero hero--inline">
    <div class="hero-left">
      <h2>Mis turnos</h2>
      <p>Revisá tus turnos, cancelá los próximos y calificá la atención.</p>
    </div>

    <div class="hero-right">
      <mat-form-field appearance="outline" class="toolbar__filtro">
        <mat-label>Buscar</mat-label>
        <input
          matInput
          #f
          (input)="applyFilter(f.value)"
          placeholder="Especialidad, especialista, estado o términos de la historia clínica" />
      </mat-form-field>

      <span class="toolbar__count" *ngIf="turnos.length">
        {{ turnos.length }} turno(s) encontrado(s)
      </span>

      <button mat-stroked-button color="primary" routerLink="/solicitar-turno" class="hero-btn">
        <mat-icon>add_circle</mat-icon>
        Solicitar turno
      </button>
    </div>
  </header> -->


  <!-- TOOLBAR DE BÚSQUEDA -->
  <div class="toolbar">
    <mat-form-field appearance="outline" class="toolbar__filtro">
      <mat-label>Buscar</mat-label>
      <input matInput #f (input)="applyFilter(f.value)"
        placeholder="Especialidad, especialista, estado o términos de la historia clínica" />
    </mat-form-field>

    <span class="toolbar__count" *ngIf="turnos.length">
      {{ turnos.length }} turno(s) encontrado(s)
    </span>
  </div>

  <!-- LISTA DE TURNOS COMO CARDS -->
  <section class="lista" *ngIf="turnos.length; else sinTurnos">

    <!-- section class="lista" *ngIf="turnos.length; else sinTurnos" -->


    <article class="turno-card" *ngFor="let t of turnos">
      <!-- Cabecera: fecha, hora, estado -->
      <div class="card-header">
        <div class="fecha-hora">
          <div class="fecha">{{ t.fecha | date:'EEEE d \'de\' MMMM' }}</div>
          <div class="hora">{{ t.hora }}</div>
        </div>

        <span class="estado-chip" [appStatusBadge]="t.estado">
          {{ t.estado | statusLabel }}
        </span>
      </div>

      <!-- Cuerpo: especialidad, especialista, calificación -->
      <div class="card-body">
        <div class="linea">
          <span class="label">Especialidad</span>
          <span class="valor">{{ t.especialidad }}</span>
        </div>
        <div class="linea">
          <span class="label">Profesional</span>
          <span class="valor">{{ t.especialista }} - {{ t.especialidad }}</span>
        </div>
        <div class="linea" *ngIf="t.calificacion">
          <span class="label">Calificación</span>
          <span class="valor estrellas">★ {{ t.calificacion }} / 5</span>
        </div>
      </div>

      <!-- Acciones -->
      <div class="card-actions">
        <!-- Cancelar: solo si no fue realizado y es futuro -->
        <button mat-stroked-button color="warn" (click)="cancelarTurno(t)" [disabled]="!puedeCancelar(t)"
          *ngIf="t.estado !== 'realizado'">
          <mat-icon>event_busy</mat-icon>
          Cancelar
        </button>

        <!-- Ver reseña: si tiene reseña -->
        <button mat-button (click)="verResena(t)" *ngIf="puedeVerResena(t)">
          <mat-icon>rate_review</mat-icon>
          Ver reseña
        </button>

        <!-- Completar encuesta: realizado + tiene reseña + sin encuesta -->
        <button mat-button color="primary" (click)="completarEncuesta(t)" *ngIf="puedeCompletarEncuesta(t)">
          <mat-icon>assignment</mat-icon>
          Completar encuesta
        </button>

        <!-- Calificar: solo si fue realizado -->
        <button mat-button color="accent" (click)="calificarAtencion(t)" *ngIf="puedeCalificar(t)">
          <mat-icon>star_rate</mat-icon>
          Calificar
        </button>
      </div>
    </article>
  </section>
</mat-card>

<!-- Si no hay turnos -->
<ng-template #sinTurnos>
  <div class="empty">
    <p>No tenés turnos registrados.</p>
    <button mat-raised-button color="primary" routerLink="/solicitar-turno">
      <mat-icon>add_circle</mat-icon>
      Solicitar mi primer turno
    </button>
  </div>
</ng-template>

<!-- Diálogos se mantienen tal cual -->
<!-- cancelDialog -->
<ng-template #cancelDialog let-data>
  <h2 mat-dialog-title>Cancelar Turno</h2>
  <mat-dialog-content>
    <p>¿Estás seguro de que deseas cancelar este turno?</p>
    <p><strong>Especialidad:</strong> {{ data?.turno?.especialidad }}</p>
    <p><strong>Especialista:</strong> {{ data?.turno?.especialista }}</p>
    <p><strong>Fecha:</strong> {{ data?.turno?.fecha | date:'shortDate' }} a las {{ data?.turno?.hora }}</p>

    <form [formGroup]="data?.form" style="margin-top: 16px;">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Motivo de cancelación</mat-label>
        <textarea matInput formControlName="comentario" rows="4"
          placeholder="Indica el motivo de la cancelación (mínimo 10 caracteres)"></textarea>
        <mat-error *ngIf="data?.form?.get('comentario')?.hasError('required')">
          El motivo es obligatorio
        </mat-error>
        <mat-error *ngIf="data?.form?.get('comentario')?.hasError('minlength')">
          Debe tener al menos 10 caracteres
        </mat-error>
      </mat-form-field>
    </form>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Cancelar</button>
    <button mat-raised-button color="warn" [disabled]="!data?.form?.valid" [mat-dialog-close]="true">
      Confirmar Cancelación
    </button>
  </mat-dialog-actions>
</ng-template>

<!-- calificarDialog -->
<ng-template #calificarDialog let-data>
  <h2 mat-dialog-title>Calificar Atención</h2>
  <mat-dialog-content>
    <p>¿Cómo fue tu experiencia con la atención recibida?</p>
    <p><strong>Especialista:</strong> {{ data?.turno?.especialista }}</p>
    <p><strong>Fecha:</strong> {{ data?.turno?.fecha | date:'shortDate' }}</p>

    <form [formGroup]="data?.form" style="margin-top: 16px;">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Calificación</mat-label>
        <mat-select formControlName="estrellas">
          <mat-option [value]="5">⭐⭐⭐⭐⭐ (5) Excelente</mat-option>
          <mat-option [value]="4">⭐⭐⭐⭐ (4) Muy bueno</mat-option>
          <mat-option [value]="3">⭐⭐⭐ (3) Bueno</mat-option>
          <mat-option [value]="2">⭐⭐ (2) Regular</mat-option>
          <mat-option [value]="1">⭐ (1) Malo</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Comentario sobre la atención</mat-label>
        <textarea matInput formControlName="comentario" rows="4"
          placeholder="Describe cómo fue tu experiencia (mínimo 10 caracteres)"></textarea>
        <mat-error *ngIf="data?.form?.get('comentario')?.hasError('required')">
          El comentario es obligatorio
        </mat-error>
        <mat-error *ngIf="data?.form?.get('comentario')?.hasError('minlength')">
          Debe tener al menos 10 caracteres
        </mat-error>
      </mat-form-field>
    </form>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Cancelar</button>
      <button mat-raised-button color="accent" [disabled]="!data?.form?.valid" [mat-dialog-close]="true">
      Guardar Calificación
    </button>
  </mat-dialog-actions>
</ng-template>

<!-- Diálogo para ver reseña -->
<ng-template #verResenaDialog let-data>
  <h2 mat-dialog-title>Reseña del Especialista</h2>
  <mat-dialog-content>
    <p><strong>Especialista:</strong> {{ data?.turno?.especialista }}</p>
    <p><strong>Especialidad:</strong> {{ data?.turno?.especialidad }}</p>
    <p><strong>Fecha:</strong> {{ data?.turno?.fecha | date:'shortDate' }} a las {{ data?.turno?.hora }}</p>
    
    <div style="margin-top: 16px; padding: 16px; background-color: #f5f5f5; border-radius: 4px;">
      <p style="margin: 0; white-space: pre-wrap;">{{ data?.resena }}</p>
    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Cerrar</button>
  </mat-dialog-actions>
</ng-template>