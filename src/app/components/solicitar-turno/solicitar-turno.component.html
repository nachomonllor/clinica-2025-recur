<mat-card class="st-shell mat-elevation-z6">
  <header class="st-hero">
    <div class="hero-text">
      <h2>
        {{
          esAdmin
            ? ('APPOINTMENT.TITLE_ADMIN' | translate)
            : ('APPOINTMENT.TITLE' | translate)
        }}
      </h2>
      <p>{{ 'APPOINTMENT.SUBTITLE' | translate }}</p>
    </div>
    <div class="hero-badge">
      <span class="dot"></span>
      {{ 'APPOINTMENT.BADGE' | translate }}
    </div>
  </header>

  <nav class="st-steps">
    <div class="step" 
         [class.done]="formularioTurno.get('especialidad')?.valid"
         [class.active]="!formularioTurno.get('especialidad')?.valid">
      <span>1</span>
      {{ 'APPOINTMENT.STEPS.SPECIALITY' | translate }}
    </div>
    <div class="step" 
         [class.disabled]="!formularioTurno.get('especialidad')?.valid"
         [class.done]="formularioTurno.get('especialista')?.valid" 
         [class.active]="formularioTurno.get('especialidad')?.valid && !formularioTurno.get('especialista')?.valid">
      <span>2</span>
      {{ 'APPOINTMENT.STEPS.SPECIALIST' | translate }}
    </div>
    <div class="step" 
         [class.disabled]="!formularioTurno.get('especialista')?.valid"
         [class.done]="formularioTurno.get('dia')?.valid" 
         [class.active]="formularioTurno.get('especialista')?.valid && !formularioTurno.get('dia')?.valid">
      <span>3</span>
      {{ 'APPOINTMENT.STEPS.DAY' | translate }}
    </div>
    <div class="step" 
         [class.disabled]="!formularioTurno.get('dia')?.valid"
         [class.done]="formularioTurno.get('hora')?.valid" 
         [class.active]="formularioTurno.get('dia')?.valid && !formularioTurno.get('hora')?.valid">
      <span>4</span>
      {{ 'APPOINTMENT.STEPS.TIME' | translate }}
    </div>
  </nav>

  <form [formGroup]="formularioTurno" (ngSubmit)="onSubmit()" class="st-grid">
    <section class="st-column form">
      
      <mat-form-field appearance="outline" class="full">
        <mat-label>
          {{ 'APPOINTMENT.FORM.SPECIALITY_LABEL' | translate }}
        </mat-label>
        <mat-select formControlName="especialidad">
          <mat-option *ngFor="let esp of especialidades" [value]="esp">
            {{ esp }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="formularioTurno.get('especialidad')?.hasError('required')">
          {{ 'APPOINTMENT.FORM.SPECIALITY_REQUIRED' | translate }}
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full">
        <mat-label>
          {{ 'APPOINTMENT.FORM.SPECIALIST_LABEL' | translate }}
        </mat-label>
        <mat-select formControlName="especialista">
          <mat-option *ngFor="let esp of especialistasFiltrados" [value]="esp.id">
            {{ esp.apellido | capitalizarNombre }}, {{ esp.nombre | capitalizarNombre }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="formularioTurno.get('especialista')?.hasError('required')">
          {{ 'APPOINTMENT.FORM.SPECIALIST_REQUIRED' | translate }}
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full" *ngIf="esAdmin">
        <mat-label>
          {{ 'APPOINTMENT.FORM.PATIENT_LABEL' | translate }}
        </mat-label>
        <mat-select formControlName="paciente">
          <mat-option *ngFor="let pac of pacientes" [value]="pac.id">
            {{ pac.apellido | capitalizarNombre }}, {{ pac.nombre | capitalizarNombre }} (DNI: {{ pac.dni || '---' }})
          </mat-option>
        </mat-select>
        <mat-error *ngIf="formularioTurno.get('paciente')?.hasError('required')">
          {{ 'APPOINTMENT.FORM.PATIENT_REQUIRED' | translate }}
        </mat-error>
      </mat-form-field>

      <div class="field-title">
        {{ 'APPOINTMENT.FORM.DAY_TITLE' | translate }}
      </div>
      <div class="days-grid" *ngIf="diasDisponibles.length">
        <button type="button" class="day-card" 
                *ngFor="let d of diasDisponibles" 
                [class.selected]="isDiaSelected(d)"
                (click)="selectDia(d)">
          <span class="day-label">{{ d.split('|')[1] }}</span>
        </button>
      </div>

      <div class="field-title">
        {{ 'APPOINTMENT.FORM.TIME_TITLE' | translate }}
      </div>
      <div class="hours-grid">
        <button type="button" class="time-pill" 
                *ngFor="let h of horariosDisponibles"
                [class.selected]="isHoraSelected(h)" 
                (click)="selectHora(h)">
          {{ h }}
        </button>
      </div>

      <div class="actions">
        <button mat-raised-button type="button" class="btn-secondary" (click)="router.navigate(['/bienvenida'])">
          {{ 'APPOINTMENT.ACTIONS.CANCEL' | translate }}
        </button>
        <button mat-raised-button color="primary" type="submit" class="btn-primary"
          [disabled]="loading || formularioTurno.invalid">
          {{ loading ? ('APPOINTMENT.ACTIONS.SUBMIT_LOADING' | translate) : ('APPOINTMENT.ACTIONS.SUBMIT' | translate) }}
        </button>
      </div>
    </section>

    <aside class="st-column preview">
      <h3>{{ 'APPOINTMENT.SUMMARY.TITLE' | translate }}</h3>
      <div class="summary">
        <div class="row">
          <span>{{ 'APPOINTMENT.SUMMARY.SPECIALITY' | translate }}</span>
          <strong>
            {{ formularioTurno.get('especialidad')?.value || '—' }}
          </strong>
        </div>
        <div class="row">
          <span>{{ 'APPOINTMENT.SUMMARY.SPECIALIST' | translate }}</span>
          <strong>
            {{ especialistaLabel($any(formularioTurno.get('especialista'))?.value) || '—' }}
          </strong>
        </div>
        
        <div class="row" *ngIf="esAdmin && formularioTurno.get('paciente')?.value">
           <span>Paciente</span>
           <strong>Seleccionado</strong>
        </div>

        <div class="row">
          <span>{{ 'APPOINTMENT.SUMMARY.DAY' | translate }}</span>
          <strong>
            {{ formularioTurno.value.dia ? $any(formularioTurno.value.dia).split('|')[1] : '—' }}
          </strong>
        </div>
        <div class="row">
          <span>{{ 'APPOINTMENT.SUMMARY.TIME' | translate }}</span>
          <strong>
            {{ formularioTurno.get('hora')?.value || '—' }}
          </strong>
        </div>
      </div>

      <div class="note">
        <mat-icon>info</mat-icon>
        {{ 'APPOINTMENT.NOTE' | translate }}
      </div>
    </aside>
  </form>
</mat-card>


<!-- <mat-card class="st-shell mat-elevation-z6">
  <header class="st-hero">
    <div class="hero-text">
      <h2>
        {{
        esAdmin
        ? ('APPOINTMENT.TITLE_ADMIN' | translate)
        : ('APPOINTMENT.TITLE' | translate)
        }}
      </h2>
      <p>{{ 'APPOINTMENT.SUBTITLE' | translate }}</p>
    </div>
    <div class="hero-badge">
      <span class="dot"></span>
      {{ 'APPOINTMENT.BADGE' | translate }}
    </div>
  </header>
  <nav class="st-steps">
    <div class="step" [class.done]="formularioTurno.get('especialidad')?.valid"
      [class.active]="!formularioTurno.get('especialidad')?.valid">
      <span>1</span>
      {{ 'APPOINTMENT.STEPS.SPECIALITY' | translate }}
    </div>
    <div class="step" [class.disabled]="!formularioTurno.get('especialidad')?.valid"
      [class.done]="formularioTurno.get('especialista')?.valid" [class.active]="
        formularioTurno.get('especialidad')?.valid &&
        !formularioTurno.get('especialista')?.valid
      ">
      <span>2</span>
      {{ 'APPOINTMENT.STEPS.SPECIALIST' | translate }}
    </div>
    <div class="step" [class.disabled]="!formularioTurno.get('especialista')?.valid"
      [class.done]="formularioTurno.get('dia')?.valid" [class.active]="
        formularioTurno.get('especialista')?.valid &&
        !formularioTurno.get('dia')?.valid
      ">
      <span>3</span>
      {{ 'APPOINTMENT.STEPS.DAY' | translate }}
    </div>
    <div class="step" [class.disabled]="!formularioTurno.get('dia')?.valid"
      [class.done]="formularioTurno.get('hora')?.valid" [class.active]="
        formularioTurno.get('dia')?.valid &&
        !formularioTurno.get('hora')?.valid
      ">
      <span>4</span>
      {{ 'APPOINTMENT.STEPS.TIME' | translate }}
    </div>
  </nav>

  <form [formGroup]="formularioTurno" (ngSubmit)="onSubmit()" class="st-grid">
    <section class="st-column form">
      <mat-form-field appearance="outline" class="full">
        <mat-label>
          {{ 'APPOINTMENT.FORM.SPECIALITY_LABEL' | translate }}
        </mat-label>
        <mat-select formControlName="especialidad">
          <mat-option *ngFor="let esp of especialidades" [value]="esp">
            {{ esp }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="
            formularioTurno.get('especialidad')?.hasError('required')
          ">
          {{ 'APPOINTMENT.FORM.SPECIALITY_REQUIRED' | translate }}
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full">
        <mat-label>
          {{ 'APPOINTMENT.FORM.SPECIALIST_LABEL' | translate }}
        </mat-label>
        <mat-select formControlName="especialista">
          <mat-option *ngFor="let esp of especialistasFiltrados" [value]="esp.id">
            {{ esp.apellido | capitalizarNombre }}, {{ esp.nombre | capitalizarNombre }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="
            formularioTurno.get('especialista')?.hasError('required')
          ">
          {{ 'APPOINTMENT.FORM.SPECIALIST_REQUIRED' | translate }}
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full" *ngIf="esAdmin">
        <mat-label>
          {{ 'APPOINTMENT.FORM.PATIENT_LABEL' | translate }}
        </mat-label>
        <mat-select formControlName="paciente">
          <mat-option *ngFor="let pac of pacientes" [value]="pac.id">
            {{ pac.apellido | capitalizarNombre }}, {{ pac.nombre | capitalizarNombre }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="formularioTurno.get('paciente')?.hasError('required')">
          {{ 'APPOINTMENT.FORM.PATIENT_REQUIRED' | translate }}
        </mat-error>
      </mat-form-field>

      <div class="field-title">
        {{ 'APPOINTMENT.FORM.DAY_TITLE' | translate }}
      </div>
      <div class="days-grid" *ngIf="diasDisponibles.length">
        <button type="button" class="day-card" *ngFor="let d of diasDisponibles" [class.selected]="isDiaSelected(d)"
          (click)="selectDia(d)">
          <span class="day-label">{{ d.split('|')[1] }}</span>
        </button>
      </div>

      <div class="field-title">
        {{ 'APPOINTMENT.FORM.TIME_TITLE' | translate }}
      </div>
      <div class="hours-grid">
        <button type="button" class="time-pill" *ngFor="let h of horariosDisponibles"
          [class.selected]="isHoraSelected(h)" (click)="selectHora(h)">
          {{ h }}
        </button>
      </div>

      <div class="actions">
        <button mat-raised-button type="button" class="btn-secondary" (click)="router.navigate(['/bienvenida'])">
          {{ 'APPOINTMENT.ACTIONS.CANCEL' | translate }}
        </button>
        <button mat-raised-button color="primary" type="submit" class="btn-primary"
          [disabled]="loading || formularioTurno.invalid">
          {{
          loading
          ? ('APPOINTMENT.ACTIONS.SUBMIT_LOADING' | translate)
          : ('APPOINTMENT.ACTIONS.SUBMIT' | translate)
          }}
        </button>
      </div>
    </section>

    <aside class="st-column preview">
      <h3>{{ 'APPOINTMENT.SUMMARY.TITLE' | translate }}</h3>
      <div class="summary">
        <div class="row">
          <span>{{ 'APPOINTMENT.SUMMARY.SPECIALITY' | translate }}</span>
          <strong>
            {{ formularioTurno.get('especialidad')?.value || '—' }}
          </strong>
        </div>
        <div class="row">
          <span>{{ 'APPOINTMENT.SUMMARY.SPECIALIST' | translate }}</span>
          <strong>
            {{
            especialistaLabel(
            $any(formularioTurno.get('especialista'))?.value
            ) || '—'
            }}
          </strong>
        </div>
        <div class="row">
          <span>{{ 'APPOINTMENT.SUMMARY.DAY' | translate }}</span>
          <strong>
            {{
            formularioTurno.value.dia
            ? $any(formularioTurno.value.dia).split('|')[1]
            : '—'
            }}
          </strong>
        </div>
        <div class="row">
          <span>{{ 'APPOINTMENT.SUMMARY.TIME' | translate }}</span>
          <strong>
            {{ formularioTurno.get('hora')?.value || '—' }}
          </strong>
        </div>
      </div>

      <div class="note">
        <mat-icon>info</mat-icon>
        {{ 'APPOINTMENT.NOTE' | translate }}
      </div>
    </aside>
  </form>
</mat-card> -->