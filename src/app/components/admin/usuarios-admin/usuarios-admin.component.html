<div class="page">


  <!-- Header / Filtros -->
  <header class="header glass">
    <div class="brand">
      <div class="brand-logo">üè•</div>
      <div class="brand-text">
        <strong>Cl√≠nica Monllor</strong>
        <small>Usuarios</small>
      </div>
    </div>

    <div class="action-buttons">
      <button mat-stroked-button color="accent" (click)="descargarExcel()">
        <mat-icon>table_view</mat-icon>
        Descargar Excel general
      </button>

      <button mat-stroked-button color="warn" (click)="descargarUsuariosPdf()">
        <mat-icon>picture_as_pdf</mat-icon>
        Descargar usuarios PDF
      </button>


    </div>

    <div class="filters">
      <div class="search glass">
        <svg class="icon" viewBox="0 0 20 20" aria-hidden="true">
          <path
            d="M12.9 14.32a7 7 0 1 1 1.41-1.41l3.9 3.9a1 1 0 1 1-1.41 1.41l-3.9-3.9zM14 8a6 6 0 1 0-12 0 6 6 0 0 0 12 0z" />
        </svg>
        <input type="search" placeholder="Buscar por nombre, email, obra social o especialidad..."
          [(ngModel)]="search" />  
          <!-- vincula el input de b√∫squeda con la variable search en el componente TypeScript. 
           Cuando el usuario escribe la variable se actualiza automaticamente ===> lo que dispara el filtrado de la lista  -->
      </div>

      <div class="chips">
        <button class="chip" [class.active]="filtroRol === 'todos'" (click)="filtroRol = 'todos'">Todos</button>

        <!--- [class.active]="filtroRol === AGREGA la clase CSS active al boton solo si la variable filtroRol coincide con el valor indicado
         (ej. 'todos', 'ESPECIALISTA') Esto resalta visualmente el filtro seleccionado. -->

        <button class="chip" [class.active]="filtroRol === 'ESPECIALISTA'"
          (click)="filtroRol = 'ESPECIALISTA'">Especialistas</button>
        <button class="chip" [class.active]="filtroRol === 'PACIENTE'"
          (click)="filtroRol = 'PACIENTE'">Pacientes</button>
      </div>

      <label class="only-enabled">
        <input type="checkbox" [(ngModel)]="soloHabilitados" />
        <span>Solo habilitados</span>
      </label>
    </div>
  </header>


  <!-- trackById: Ayuda a Angular a identificar cada elemento de la lista de forma √∫nica (por su ID), 
      evitando renderizar de nuevo toda la lista si solo cambia un elemento. 
      [@listStagger] y [@cardInOut]: Estas son las animaciones que definiste en el TypeScript. 
      @listStagger controla la aparicion escalonada de las tarjetas,
       y @cardInOut la entrada-salida de cada tarjeta individual.
      --> 
  <!-- Grilla de tarjetas -->
  <section class="grid" [@listStagger]>

    <!-- [ngClass]="...": Asigna clases CSS dinamicamente. 
     Por ejemplo, u.color asigna un color de borde/acento seg√∫n el usuario, 
     y card-lg y card-sm ajusta el tama√±o de la tarjeta seg√∫n el rol. -->

    <article class="user-card" [@cardInOut] *ngFor="let u of filtered; trackBy: trackById"
      [ngClass]="[u.color, u.rol === 'PACIENTE' ? 'card-lg' : 'card-sm']">
      <div class="accent"></div>

      <!-- Cabecera -->
      <div class="card-header">
        <div class="avatar" [class.has-img]="u.avatarUrl">
          <img *ngIf="u.avatarUrl" [src]="u.avatarUrl" [alt]="u.nombre + ' ' + u.apellido"  />
          <span *ngIf="!u.avatarUrl">{{ initials(u) }}</span>
        </div>

        <div class="title">
          <h3>
            {{ u.rol === 'ESPECIALISTA' ? (u.nombre | capitalizarNombre | doctor) : (u.nombre | capitalizarNombre) }}
            {{ u.apellido | capitalizarNombre }}
          </h3>

          <div class="sub">
            <span class="role">{{ rolChip(u) }}</span>
            <span class="dot" *ngIf="u.edad !== undefined"></span>
            <span *ngIf="u.edad !== undefined">{{ u.edad }} a√±os</span>
          </div>
        </div>

        <!-- <span class="status" [@statusChanged]="u.habilitado">
          {{ u.habilitado ? 'HABILITADO' : 'DESHABILITADO' }}
        </span> -->

        <span class="status" [class.active]="u.habilitado" [@statusChanged]="u.habilitado">
          {{ u.habilitado ? 'HABILITADO' : 'DESHABILITADO' }}
        </span>


      </div>

      <!-- Cuerpo -->
      <div class="card-body" [ngClass]="{'is-paciente': u.rol === 'PACIENTE'}">
        <div class="info">
          <div class="info-row">
            <span class="label">Email</span>
            <a class="value email" [href]="'mailto:' + u.email">{{ u.email }}</a>
          </div>

          <div class="info-row" *ngIf="u.dni">
            <span class="label">DNI</span>
            <span class="value">{{ u.dni }}</span>
          </div>

          <div class="info-row" *ngIf="u.rol === 'PACIENTE' && u.obraSocial">
            <span class="label">Obra social</span>
            <span class="value tag">{{ u.obraSocial }}</span>
          </div>

          <div class="info-row" *ngIf="u.rol === 'ESPECIALISTA' && u.especialidades?.length">
            <span class="label">Especialidades</span>
            <span class="chips-line">
              <span class="chip sm" *ngFor="let e of u.especialidades">{{ e }}</span>
            </span>
          </div>
        </div>

        <div class="actions" *ngIf="u.rol === 'PACIENTE'; else accionesEspecialista">
          <button class="btn primary ripple" (click)="verHistoria(u)">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M4 6a2 2 0 012-2h8l6 6v10a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 4v4h4" />
            </svg>
            Ver historia cl√≠nica
          </button>

          <button class="btn ghost ripple" (click)="descargarTurnos(u)">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M12 3v12m0 0l-4-4m4 4l4-4M5 21h14" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            Descargar turnos
          </button>

          <button class="btn admin-btn ripple" *ngIf="esAdmin" (click)="hacerAdmin(u)"
            title="Convertir en Administrador">
            <mat-icon>admin_panel_settings</mat-icon>
            Hacer Admin
          </button>
        </div>

        <ng-template #accionesEspecialista>
          <div class="actions">

            <button class="btn danger ripple" *ngIf="esAdmin" (click)="alternarHabilitado(u)"
              [attr.aria-pressed]="!u.habilitado">
              <svg class="icon" viewBox="0 0 24 24">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              {{ u.habilitado ? 'Deshabilitar' : 'Habilitar' }}
            </button>

            <button class="btn pdf-btn ripple" (click)="descargarPdf(u)" title="Descargar Atenciones en PDF">
              <mat-icon>picture_as_pdf</mat-icon>
              Descargar en PDF
            </button>


            <button class="btn admin-btn ripple" *ngIf="esAdmin && u.rol !== 'ADMIN'" (click)="hacerAdmin(u)"
              title="Convertir en Administrador">
              <mat-icon>admin_panel_settings</mat-icon>
              Hacer Admin
            </button>

          </div>
        </ng-template>


      </div>
    </article>
  </section>
</div>