<div class="page">
  <!-- Header / Filtros -->
  <header class="header glass">
    <div class="brand">
      <div class="brand-logo">游낀</div>
      <div class="brand-text">
        <strong>Cl칤nica Monllor</strong>
        <small>Usuarios</small>
      </div>
    </div>

    <div class="filters">
      <div class="search glass">
        <svg class="icon" viewBox="0 0 20 20" aria-hidden="true">
          <path d="M12.9 14.32a7 7 0 1 1 1.41-1.41l3.9 3.9a1 1 0 1 1-1.41 1.41l-3.9-3.9zM14 8a6 6 0 1 0-12 0 6 6 0 0 0 12 0z"/>
        </svg>
        <input type="search"
               placeholder="Buscar por nombre, email, obra social o especialidad..."
               [(ngModel)]="search" />
      </div>

      <div class="chips">
        <button class="chip" [class.active]="filtroRol === 'todos'" (click)="filtroRol = 'todos'">Todos</button>
        <button class="chip" [class.active]="filtroRol === 'ESPECIALISTA'" (click)="filtroRol = 'ESPECIALISTA'">Especialistas</button>
        <button class="chip" [class.active]="filtroRol === 'PACIENTE'" (click)="filtroRol = 'PACIENTE'">Pacientes</button>
      </div>

      <label class="only-enabled">
        <input type="checkbox" [(ngModel)]="soloHabilitados" />
        <span>Solo habilitados</span>
      </label>
    </div>
  </header>

  <!-- Grilla de tarjetas -->
  <section class="grid" [@listStagger]>
    <article class="user-card"
             [@cardInOut]
             *ngFor="let u of filtered; trackBy: trackById"
             [ngClass]="[u.color, u.rol === 'PACIENTE' ? 'card-lg' : 'card-sm']">
      <div class="accent"></div>

      <!-- Cabecera -->
      <div class="card-header">
        <div class="avatar" [class.has-img]="u.avatarUrl">
          <img *ngIf="u.avatarUrl" [src]="u.avatarUrl" [alt]="u.nombre + ' ' + u.apellido" />
          <span *ngIf="!u.avatarUrl">{{ initials(u) }}</span>
        </div>

        <div class="title">
          <h3>{{ u.nombre | capitalizarNombre}} {{ u.apellido | capitalizarNombre }}</h3>

          <div class="sub">
            <span class="role">{{ rolChip(u) }}</span>
            <span class="dot" *ngIf="u.edad !== undefined"></span>
            <span *ngIf="u.edad !== undefined">{{ u.edad }} a침os</span>
          </div>
        </div>

        <span class="status" [@statusChanged]="u.habilitado">
          {{ u.habilitado ? 'HABILITADO' : 'DESHABILITADO' }}
        </span>
      </div>

      <!-- Cuerpo -->
      <div class="card-body" [ngClass]="{'is-paciente': u.rol === 'PACIENTE'}">
        <div class="info">
          <div class="info-row">
            <span class="label">Email</span>
            <a class="value email" [href]="'mailto:' + u.email">{{ u.email }}</a>
          </div>

          <div class="info-row" *ngIf="u.dni">
            <span class="label">DNI</span>
            <span class="value">{{ u.dni }}</span>
          </div>

          <div class="info-row" *ngIf="u.rol === 'PACIENTE' && u.obraSocial">
            <span class="label">Obra social</span>
            <span class="value tag">{{ u.obraSocial }}</span>
          </div>

          <div class="info-row" *ngIf="u.rol === 'ESPECIALISTA' && u.especialidades?.length">
            <span class="label">Especialidades</span>
            <span class="chips-line">
              <span class="chip sm" *ngFor="let e of u.especialidades">{{ e }}</span>
            </span>
          </div>
        </div>

        <!-- Acciones -->
        <div class="actions" *ngIf="u.rol === 'PACIENTE'; else accionesEspecialista">
          <button class="btn primary ripple" (click)="verHistoria(u)">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M4 6a2 2 0 012-2h8l6 6v10a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 4v4h4"/>
            </svg>
            Ver historia cl칤nica
          </button>
          <button class="btn ghost ripple" (click)="descargarTurnos(u)">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M12 3v12m0 0l-4-4m4 4l4-4M5 21h14" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Descargar turnos
          </button>
        </div>

        <ng-template #accionesEspecialista>
          <div class="actions">
            
            <!-- Bot칩n Habilitar/Deshabilitar -->
            <button class="btn danger ripple" *ngIf="esAdmin" (click)="toggleHabilitado(u)" [attr.aria-pressed]="!u.habilitado">
              <svg class="icon" viewBox="0 0 24 24">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              {{ u.habilitado ? 'Deshabilitar' : 'Habilitar' }}
            </button>

      
            <!-- UPARA AGREGADOS USA EL HELPRE DE PDF -->
            <button class="btn pdf-btn ripple" (click)="descargarPdf(u)" title="Descargar Atenciones en PDF">
                <mat-icon>picture_as_pdf</mat-icon>
                Descargar en PDF
            </button>

          </div>
        </ng-template>
      </div>
    </article>
  </section>
</div>







<!-- <div class="page">
  <header class="header glass">
    <div class="brand">
      <div class="brand-logo">游낀</div>
      <div class="brand-text">
        <strong>Cl칤nica Monllor</strong>
        <small>Usuarios</small>
      </div>
    </div>

    <div class="filters">
      <div class="search glass">
        <svg class="icon" viewBox="0 0 20 20" aria-hidden="true">
          <path
            d="M12.9 14.32a7 7 0 1 1 1.41-1.41l3.9 3.9a1 1 0 1 1-1.41 1.41l-3.9-3.9zM14 8a6 6 0 1 0-12 0 6 6 0 0 0 12 0z" />
        </svg>
        <input type="search" placeholder="Buscar por nombre, email, obra social o especialidad..."
          [(ngModel)]="search" />
      </div>

      <div class="chips">
        <button class="chip" [class.active]="filtroRol === 'todos'" (click)="filtroRol = 'todos'">Todos</button>
        <button class="chip" [class.active]="filtroRol === 'ESPECIALISTA'"
          (click)="filtroRol = 'ESPECIALISTA'">Especialistas</button>
        <button class="chip" [class.active]="filtroRol === 'PACIENTE'"
          (click)="filtroRol = 'PACIENTE'">Pacientes</button>
      </div>

      <label class="only-enabled">
        <input type="checkbox" [(ngModel)]="soloHabilitados" />
        <span>Solo habilitados</span>
      </label>
    </div>
  </header>

  <section class="grid" [@listStagger]>
    <article class="user-card" [@cardInOut] *ngFor="let u of filtered; trackBy: trackById"
      [ngClass]="[u.color, u.rol === 'PACIENTE' ? 'card-lg' : 'card-sm']">
      <div class="accent"></div>

      <div class="card-header">
        <div class="avatar" [class.has-img]="u.avatarUrl">
          <img *ngIf="u.avatarUrl" [src]="u.avatarUrl" [alt]="u.nombre + ' ' + u.apellido" />
          <span *ngIf="!u.avatarUrl">{{ initials(u) }}</span>
        </div>

        <div class="title">
          <h3>{{ u.nombre | capitalizarNombre}} {{ u.apellido | capitalizarNombre }}</h3>
          <div class="sub">
            <span class="role">{{ rolChip(u) }}</span>
            <span class="dot" *ngIf="u.edad !== undefined"></span>
            <span *ngIf="u.edad !== undefined">{{ u.edad }} a침os</span>
          </div>
        </div>

        <span class="status" [@statusChanged]="u.habilitado">
          {{ u.habilitado ? 'HABILITADO' : 'DESHABILITADO' }}
        </span>
      </div>

      <div class="card-body" [ngClass]="{'is-paciente': u.rol === 'PACIENTE'}">
        <div class="info">
          <div class="info-row">
            <span class="label">Email</span>
            <a class="value email" [href]="'mailto:' + u.email">{{ u.email }}</a>
          </div>

          <div class="info-row" *ngIf="u.dni">
            <span class="label">DNI</span>
            <span class="value">{{ u.dni }}</span>
          </div>

          <div class="info-row" *ngIf="u.rol === 'PACIENTE' && u.obraSocial">
            <span class="label">Obra social</span>
            <span class="value tag">{{ u.obraSocial }}</span>
          </div>

          <div class="info-row" *ngIf="u.rol === 'ESPECIALISTA' && u.especialidades?.length">
            <span class="label">Especialidades</span>
            <span class="chips-line">
              <span class="chip sm" *ngFor="let e of u.especialidades">{{ e }}</span>
            </span>
          </div>
        </div>
        <div class="actions" *ngIf="u.rol === 'PACIENTE'; else accionesEspecialista">
          <button class="btn primary ripple" (click)="verHistoria(u)">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M4 6a2 2 0 012-2h8l6 6v10a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 4v4h4" />
            </svg>
            Ver historia cl칤nica
          </button>
          <button class="btn ghost ripple" (click)="descargarTurnos(u)">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M12 3v12m0 0l-4-4m4 4l4-4M5 21h14" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            Descargar turnos
          </button>
        </div>

        <ng-template #accionesEspecialista>
          <div class="actions">
            <button class="btn danger ripple" *ngIf="esAdmin" (click)="toggleHabilitado(u)"
              [attr.aria-pressed]="!u.habilitado">
              <svg class="icon" viewBox="0 0 24 24">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              {{ u.habilitado ? 'Deshabilitar' : 'Habilitar' }}
            </button>
          </div>
        </ng-template>
      </div>
    </article>
  </section>
</div> -->








<!-- <div class="detalle-acciones">
  
  <button mat-stroked-button color="primary" (click)="descargarTurnosUsuario(seleccionado)">
          <mat-icon>download</mat-icon>
          Turnos en Excel
        </button>

        <button mat-raised-button color="warn" (click)="descargarTurnosPdf(seleccionado)">
          <mat-icon>picture_as_pdf</mat-icon>
          Atenciones PDF
        </button>
    

        <button
          mat-stroked-button
          color="accent"
          *ngIf="seleccionado.rol === 'paciente'"
          (click)="verHistoriaClinica(seleccionado.id, seleccionado.nombre + ' ' + seleccionado.apellido)">
          <mat-icon>medical_services</mat-icon>
          Historia cl칤nica
        </button>
        
        <button
          mat-flat-button
          color="warn"
          *ngIf="seleccionado.rol === 'especialista' && esAdmin"
          (click)="toggleAprobacion(seleccionado)">
          <mat-icon>{{ seleccionado.aprobado ? 'block' : 'check_circle' }}</mat-icon>
          {{ seleccionado.aprobado ? 'Inhabilitar' : 'Habilitar' }}
        </button>
      </div>  -->



<!-- --------------------------------------------------------------------------------------------------- ->

<mat-card class="usuarios-container" appElevateOnHover>
  <mat-card-header>
    <mat-card-title>Gesti칩n de usuarios</mat-card-title>
    <mat-card-subtitle>Solo visible para administradores</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content class="usuarios-layout">
    <section class="panel panel-listado">
      <div class="panel-actions">
        <mat-form-field appearance="outline" class="buscador">
          <mat-label>Buscar usuarios</mat-label>
          <input
            matInput
            #filtroInput
            [value]="filtroTexto"
            (input)="aplicarFiltro(filtroInput.value)"
            placeholder="Nombre, apellido, email o rol" />
          <button
            mat-icon-button
            matSuffix
            *ngIf="filtroInput.value"
            aria-label="Limpiar b칰squeda"
            (click)="filtroInput.value=''; aplicarFiltro('')">
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>

        <div class="action-buttons">
          <button mat-stroked-button color="accent" (click)="descargarExcel()">
            <mat-icon>table_view</mat-icon>
            Descargar Excel general
          </button>
          <button mat-flat-button color="primary" (click)="crearUsuario()" *ngIf="!mostrarFormulario">
            <mat-icon>person_add</mat-icon>
            Crear usuario
          </button>
          <button mat-stroked-button color="warn" (click)="cancelarCreacion()" *ngIf="mostrarFormulario">
            <mat-icon>close</mat-icon>
            Cancelar alta
          </button>
        </div>
      </div>

      <div class="usuario-grid" *ngIf="usuariosFiltrados.length; else sinUsuarios">
        <button
          type="button"
          class="usuario-card"
          *ngFor="let usuario of usuariosFiltrados; trackBy: trackUsuario"
          [class.activo]="usuarioSeleccionado?.id === usuario.id"
          (click)="seleccionarUsuario(usuario)"
          matTooltip="{{ usuario.nombre }} {{ usuario.apellido }}">
          <div class="avatar">
            <img
              [src]="usuario.avatar_url || 'assets/img/default-avatar.png'"
              [alt]="usuario.nombre || 'Usuario sin nombre'"
              loading="lazy" />
          </div>
          <div class="texto">
            <span class="nombre">{{ usuario.apellido }} {{ usuario.nombre }}</span>
            <span class="meta">{{ usuario.email || 'Sin email cargado' }}</span>
            <span class="meta meta-small">Rol: {{ usuario.rol | roleLabel }}</span>
          </div>
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    </section>

    <section class="panel panel-detalle" *ngIf="usuarioSeleccionado as seleccionado; else sinSeleccion">
      <div class="detalle-encabezado">
        <div class="avatar-principal">
          <img
            [src]="seleccionado.avatar_url || 'assets/img/default-avatar.png'"
            [alt]="seleccionado.nombre || 'Avatar de usuario'"
            loading="lazy" />
        </div>
        <div class="detalle-titulos">
          <h3>{{ seleccionado.apellido }} {{ seleccionado.nombre }}</h3>
          <div class="chips">
            <mat-chip [color]="getRolColor(seleccionado.rol)" selected>
              {{ seleccionado.rol | roleLabel }}
            </mat-chip>
            <span
              *ngIf="seleccionado.rol === 'especialista'"
              [appStatusBadge]="seleccionado.aprobado ? 'realizado' : 'pendiente'">
              {{ seleccionado.aprobado ? 'Aprobado' : 'Pendiente' }}
            </span>
          </div>
          <p class="meta">
            <mat-icon>mail</mat-icon>
            {{ seleccionado.email || 'Sin email cargado' }}
          </p>
          <p class="meta" *ngIf="seleccionado.dni">
            <mat-icon>badge</mat-icon>
            DNI: {{ seleccionado.dni }}
          </p>
          <p class="meta" *ngIf="seleccionado.rol === 'paciente' && seleccionado.obra_social">
            <mat-icon>health_and_safety</mat-icon>
            Obra social: {{ seleccionado.obra_social }}
          </p>
          <p class="meta" *ngIf="seleccionado.fecha_nacimiento">
            <mat-icon>cake</mat-icon>
            Nacimiento: {{ fechaLarga(seleccionado.fecha_nacimiento) }}
          </p>
          <p class="meta" *ngIf="seleccionado.created_at">
            <mat-icon>event</mat-icon>
            Alta en sistema: {{ fechaLarga(seleccionado.created_at) }}
          </p>
        </div>
      </div>

      <div class="detalle-acciones">
        <button mat-stroked-button color="primary" (click)="descargarTurnosUsuario(seleccionado)">
          <mat-icon>download</mat-icon>
          Turnos en Excel
        </button>
        <button
          mat-stroked-button
          color="accent"
          *ngIf="seleccionado.rol === 'paciente'"
          (click)="verHistoriaClinica(seleccionado.id, seleccionado.nombre + ' ' + seleccionado.apellido)">
          <mat-icon>medical_services</mat-icon>
          Historia cl칤nica
        </button>
        <button
          mat-flat-button
          color="warn"
          *ngIf="seleccionado.rol === 'especialista' && esAdmin"
          (click)="toggleAprobacion(seleccionado)">
          <mat-icon>{{ seleccionado.aprobado ? 'block' : 'check_circle' }}</mat-icon>
          {{ seleccionado.aprobado ? 'Inhabilitar' : 'Habilitar' }}
        </button>
      </div>

      <div class="detalle-turnos">
        <h4>Turnos asociados</h4>

        <div class="detalle-cargando" *ngIf="cargandoTurnos">
          <mat-progress-spinner diameter="36" mode="indeterminate"></mat-progress-spinner>
          <span>Cargando turnos...</span>
        </div>

        <ng-container *ngIf="!cargandoTurnos">
          <div class="turno-lista" *ngIf="turnosUsuario.length; else sinTurnos">
            <article class="turno-item" *ngFor="let turno of turnosUsuario; trackBy: trackTurno">
              <div class="turno-info">
                <span class="especialidad">{{ turno.especialidad }}</span>
                <span class="fecha">{{ turno.fechaTexto }}</span>
              </div>
              <div class="turno-meta">
                <span class="contraparte">{{ turno.contraparte }}</span>
                <span class="estado" [appStatusBadge]="turno.estado">{{ turno.estado | titlecase }}</span>
              </div>
            </article>
          </div>
        </ng-container>
      </div>
    </section>

    <ng-template #sinUsuarios>
      <section class="panel panel-placeholder">
        <mat-icon>people_outline</mat-icon>
        <p>No encontramos usuarios con ese criterio.</p>
        <button mat-button color="primary" (click)="aplicarFiltro('')">Ver todos</button>
      </section>
    </ng-template>

    <ng-template #sinSeleccion>
      <section class="panel panel-placeholder">
        <mat-icon>person_search</mat-icon>
        <h3>Seleccion치 un usuario</h3>
        <p>Podr치s revisar su informaci칩n, descargar turnos y ejecutar acciones r치pidas.</p>
      </section>
    </ng-template>

    <ng-template #sinTurnos>
      <p class="sin-datos">Este usuario todav칤a no registra turnos.</p>
    </ng-template>
  </mat-card-content>
</mat-card>

<mat-card *ngIf="mostrarFormulario" class="form-card">
  <mat-card-title>Crear nuevo usuario</mat-card-title>
  <form [formGroup]="formularioUsuario" (ngSubmit)="guardarUsuario()">
    <div class="form-grid">
      <mat-form-field appearance="outline">
        <mat-label>Rol</mat-label>
        <mat-select formControlName="rol">
          <mat-option value="paciente">Paciente</mat-option>
          <mat-option value="especialista">Especialista</mat-option>
          <mat-option value="admin">Administrador</mat-option>
        </mat-select>
        <mat-error *ngIf="formularioUsuario.get('rol')?.hasError('required')">El rol es obligatorio.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="nombre" />
        <mat-error *ngIf="formularioUsuario.get('nombre')?.hasError('required')">El nombre es obligatorio.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Apellido</mat-label>
        <input matInput formControlName="apellido" />
        <mat-error *ngIf="formularioUsuario.get('apellido')?.hasError('required')">El apellido es obligatorio.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Fecha de nacimiento</mat-label>
        <input
          matInput
          type="date"
          formControlName="fechaNacimiento"
          [min]="minDateISO"
          [max]="maxDateISO" />
        <mat-error *ngIf="formularioUsuario.get('fechaNacimiento')?.hasError('required')">
          La fecha es obligatoria.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>DNI</mat-label>
        <input matInput formControlName="dni" />
        <mat-error *ngIf="formularioUsuario.get('dni')?.hasError('required')">El DNI es obligatorio.</mat-error>
      </mat-form-field>

      <mat-form-field
        appearance="outline"
        *ngIf="formularioUsuario.get('rol')?.value === 'paciente'">
        <mat-label>Obra social</mat-label>
        <input matInput formControlName="obraSocial" />
        <mat-error *ngIf="formularioUsuario.get('obraSocial')?.hasError('required')">
          La obra social es obligatoria para pacientes.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Email</mat-label>
        <input matInput type="email" formControlName="email" />
        <mat-error *ngIf="formularioUsuario.get('email')?.hasError('required')">El email es obligatorio.</mat-error>
        <mat-error *ngIf="formularioUsuario.get('email')?.hasError('email')">Formato inv치lido.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Contrase침a</mat-label>
        <input matInput type="password" formControlName="password" />
        <mat-error *ngIf="formularioUsuario.get('password')?.hasError('required')">
          La contrase침a es obligatoria.
        </mat-error>
        <mat-error *ngIf="formularioUsuario.get('password')?.hasError('minlength')">
          M칤nimo 6 caracteres.
        </mat-error>
      </mat-form-field>
    </div>

    <div class="file-group">
      <button mat-raised-button type="button" color="primary" (click)="fileInput.click()">
        Seleccionar imagen
      </button>
      <input #fileInput type="file" hidden (change)="onFileChange($event)" accept="image/*" />
      <mat-error
        *ngIf="formularioUsuario.get('imagenPerfil')?.hasError('required') && formularioUsuario.get('imagenPerfil')?.touched">
        La imagen es obligatoria.
      </mat-error>
      <div class="preview" *ngIf="imagenPrevia">
        <img [src]="imagenPrevia" alt="Previsualizaci칩n" />
      </div>
    </div>

    <div class="form-actions">
      <button mat-button type="button" (click)="cancelarCreacion()">Cancelar</button>
      <button mat-raised-button color="primary" type="submit" [disabled]="formularioUsuario.invalid">
        Guardar usuario
      </button>
    </div>
  </form>
</mat-card>
 -->