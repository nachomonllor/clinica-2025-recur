<section class="reportes">
  <header class="filtros">
    <form [formGroup]="form" class="rango">
      <label>Desde <input type="date" formControlName="desde"></label>
      <label>Hasta <input type="date" formControlName="hasta"></label>
      <div class="presets">
        <button type="button" (click)="form.patchValue({desde: (addDays(hoy,-7)).toISOString().substring(0,10), hasta: hoy.toISOString().substring(0,10)})">Últimos 7 días</button>
        <button type="button" (click)="form.patchValue({desde: (addDays(hoy,-30)).toISOString().substring(0,10), hasta: hoy.toISOString().substring(0,10)})">Últimos 30 días</button>
      </div>
    </form>

    <div class="exports">
      <button (click)="descargarCsv()">Descargar CSV</button>
      <button onclick="window.print()">Imprimir / Guardar PDF</button>
    </div>
  </header>

  <section class="kpis">
    <article class="card"><h4>Total</h4><p class="big">{{ kpi.total }}</p></article>
    <article class="card"><h4>Aceptados</h4><p class="big">{{ kpi.aceptados }}</p></article>
    <article class="card"><h4>Realizados</h4><p class="big">{{ kpi.realizados }}</p><small>{{ kpi.tasaRealizacion }}%</small></article>
    <article class="card"><h4>Cancelados / Rechazados</h4><p class="big">{{ kpi.cancelados }} / {{ kpi.rechazados }}</p></article>
  </section>

  <section class="grid">
    <article class="panel"><h3>Turnos por especialidad</h3><canvas #cvEspecialidad></canvas></article>
    <article class="panel"><h3>Turnos por día</h3><canvas #cvDia></canvas></article>
    <article class="panel"><h3>Solicitados por médico</h3><canvas #cvSolicitados></canvas></article>
    <article class="panel"><h3>Finalizados por médico</h3><canvas #cvFinalizados></canvas></article>
  </section>

  <section class="panel full">
    <h3>Log de ingresos</h3>
    <table class="tabla">
      <thead><tr><th>Usuario</th><th>Rol</th><th>Ingreso</th></tr></thead>
      <tbody>
        <tr *ngFor="let l of ingresos">
          <td>{{ l.email }}</td>
          <td>{{ l.rol }}</td>
          <td>{{ l.timestamp | date:'yyyy-MM-dd HH:mm' }}</td>
        </tr>
        <tr *ngIf="!ingresos.length"><td colspan="3">Sin ingresos en el rango.</td></tr>
      </tbody>
    </table>
  </section>

  <div *ngIf="loading" class="loading">Cargando…</div>
</section>








<!-- <h2>Reportes</h2>
<p>Tableros e informes.</p>

<section class="reportes">

     Filtros 
    <header class="filtros">
        <form [formGroup]="rangoForm" class="rango">
            <label>
                Desde
                <input type="date" formControlName="desde">
            </label>
            <label>
                Hasta
                <input type="date" formControlName="hasta">
            </label>

            <div class="presets">
                <button type="button"
                    (click)="rangoForm.patchValue({desde: (addDays(hoy,-7)).toISOString().substring(0,10), hasta: hoy.toISOString().substring(0,10)})">Últimos
                    7 días</button>
                <button type="button"
                    (click)="rangoForm.patchValue({desde: (addDays(hoy,-30)).toISOString().substring(0,10), hasta: hoy.toISOString().substring(0,10)})">Últimos
                    30 días</button>
                <button type="button"
                    (click)="rangoForm.patchValue({desde: (addDays(hoy,-90)).toISOString().substring(0,10), hasta: hoy.toISOString().substring(0,10)})">Últimos
                    90 días</button>
            </div>
        </form>

        <div class="exports" *ngIf="(turnos$ | async) as turnos; else loading">
            <button (click)="exportarExcel(turnos, (logs$ | async) ?? [])">Exportar Excel</button>
            <button (click)="exportarPdf(turnos, (logs$ | async) ?? [])">Exportar PDF</button>
        </div>
    </header>

    KPIs 
    <section class="kpis" *ngIf="(kpis$ | async) as k">
        <article class="card">
            <h4>Total de turnos</h4>
            <p class="big">{{ k.total }}</p>
        </article>
        <article class="card">
            <h4>Aceptados</h4>
            <p class="big">{{ k.aceptados }}</p>
        </article>
        <article class="card">
            <h4>Realizados</h4>
            <p class="big">{{ k.realizados }}</p>
            <small>{{ k.tasaRealizacion }}% de realización</small>
        </article>
        <article class="card">
            <h4>Cancelados / Rechazados</h4>
            <p class="big">{{ k.cancelados }} / {{ k.rechazados }}</p>
        </article>
    </section>

     Gráficos 
    <section class="grid">


        <article class="panel">
            <h3>Turnos por especialidad</h3>
            <canvas #cvEspecialidad></canvas>
        </article>

        <article class="panel">
            <h3>Turnos por día</h3>
            <canvas #cvDia></canvas>
        </article>

        <article class="panel">
            <h3>Turnos solicitados por médico</h3>
            <canvas #cvSolicitados></canvas>
        </article>

        <article class="panel">
            <h3>Turnos finalizados por médico</h3>
            <canvas #cvFinalizados></canvas>
        </article>

        <article class="panel">
            <h3>Turnos por especialidad</h3>
            <canvas #chEspecialidad baseChart [data]="(dataPorEspecialidad$ | async)!" [options]="barOpts"
                [type]="'bar'">
            </canvas>
        </article>

        <article class="panel">
            <h3>Turnos por día</h3>
            <canvas #chDia baseChart [data]="(dataPorDia$ | async)!" [options]="lineOpts" [type]="'line'">
            </canvas>
        </article>

        <article class="panel">
            <h3>Turnos solicitados por médico</h3>
            <canvas #chSolicitados baseChart [data]="(dataSolicitadosPorMedico$ | async)!" [options]="barHorizontalOpts"
                [type]="'bar'">
            </canvas>
        </article>

        <article class="panel">
            <h3>Turnos finalizados por médico</h3>
            <canvas #chFinalizados baseChart [data]="(dataFinalizadosPorMedico$ | async)!" [options]="barHorizontalOpts"
                [type]="'bar'">
            </canvas>
        </article>
    </section>

     Logs de ingresos 
    <section class="panel full">
        <h3>Log de ingresos</h3>

        <table class="tabla" *ngIf="(logs$ | async) as logs">
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th>Rol</th>
                    <th>Fecha y hora</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let l of logs">
                    <td>{{ l.email }}</td>
                    <td>{{ l.rol }}</td>
                    <td>{{ l.timestamp | date:'yyyy-MM-dd HH:mm' }}</td>
                </tr>
            </tbody>
        </table>
        <p *ngIf="(logs$ | async)?.length === 0">Sin ingresos en el rango seleccionado.</p>
    </section>

    <ng-template #loading>
        <div class="loading">Cargando…</div>
    </ng-template>
</section> -->