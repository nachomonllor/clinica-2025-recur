<mat-card class="registro-container" *ngIf="registroForm as f">
  <mat-card-header>
    <mat-card-title>Registro de Especialista</mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <form [formGroup]="registroForm" (ngSubmit)="onSubmit()" autocomplete="off">

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="nombre" placeholder="Ingresa tu nombre" />
        <mat-error *ngIf="f.get('nombre')?.hasError('required')">
          El nombre es obligatorio.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Apellido</mat-label>
        <input matInput formControlName="apellido" placeholder="Ingresa tu apellido" />
        <mat-error *ngIf="f.get('apellido')?.hasError('required')">
          El apellido es obligatorio.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>DNI</mat-label>
        <input matInput formControlName="dni" placeholder="Ingresa tu DNI" />
        <mat-error *ngIf="f.get('dni')?.hasError('required')">
          El DNI es obligatorio.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Fecha de nacimiento</mat-label>
        <input matInput type="date" formControlName="fechaNacimiento" [min]="minDateISO" [max]="maxDateISO" />
        <mat-error *ngIf="f.get('fechaNacimiento')?.hasError('required')">
          La fecha es obligatoria.
        </mat-error>
        <mat-error *ngIf="f.get('fechaNacimiento')?.hasError('formato')">
          Formato inválido.
        </mat-error>
        <mat-error *ngIf="f.get('fechaNacimiento')?.hasError('futuro')">
          No puedes nacer en el futuro.
        </mat-error>
        <mat-error *ngIf="f.get('fechaNacimiento')?.hasError('rango')">
          Edad fuera de rango permitido.
        </mat-error>
      </mat-form-field>

      <div class="especialidades-section"
        [class.has-error]="f.get('especialidades')?.invalid && f.get('especialidades')?.touched">

        <div class="especialidades-header">
          <span class="label">Seleccioná tus especialidades</span>
          <span class="counter">
            {{ especialidadesSeleccionadas.length }}/{{ maxEspecialidades }}
          </span>
        </div>

        <mat-chip-listbox formControlName="especialidades" multiple aria-label="Selección de especialidades">
          <mat-chip-option *ngFor="let esp of especialidadesBase" [value]="esp" color="accent"
            [selected]="especialidadesSeleccionadas.includes(esp)"
            [disabled]="loading || (!especialidadesSeleccionadas.includes(esp) && especialidadesSeleccionadas.length >= maxEspecialidades)">
            <mat-icon matChipAvatar *ngIf="especialidadesSeleccionadas.includes(esp)">check</mat-icon>
            {{ esp }}
          </mat-chip-option>
        </mat-chip-listbox>

        <div class="custom-specialty-wrapper" *ngIf="especialidadesSeleccionadas.includes('Otro')"
          style="display: flex; gap: 10px; align-items: flex-start; margin-top: 15px;">

          <mat-form-field appearance="outline" style="flex: 1;">
            <mat-label>Escribí la nueva especialidad</mat-label>
            <input matInput [formControl]="nuevaEspecialidadCtrl" (keyup.enter)="agregarEspecialidadCustom()"
              placeholder="Ej: Traumatología" />
            <mat-hint>Presioná Enter o el botón + para agregarla</mat-hint>
          </mat-form-field>

          <button mat-mini-fab color="primary" type="button"
            [disabled]="!nuevaEspecialidadCtrl.value || especialidadesSeleccionadas.length >= maxEspecialidades"
            (click)="agregarEspecialidadCustom()" style="margin-top: 4px;">
            <mat-icon>add</mat-icon>
          </button>
        </div>

        <mat-error
          *ngIf="especialidadesSeleccionadas.length >= maxEspecialidades && especialidadesSeleccionadas.includes('Otro')"
          style="font-size: 0.75rem; margin-top: 5px; display: block;">
          Límite alcanzado. Deseleccioná alguna para agregar una nueva.
        </mat-error>

        <div class="especialidades-error" *ngIf="f.get('especialidades')?.touched">
          <span
            *ngIf="f.get('especialidades')?.hasError('required') || f.get('especialidades')?.hasError('minSelected')">
            Seleccioná al menos una especialidad.
          </span>
        </div>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Correo Electrónico</mat-label>
        <input matInput type="email" formControlName="email" placeholder="nombre@ejemplo.com" />
        <mat-error *ngIf="f.get('email')?.hasError('required')">El correo es obligatorio.</mat-error>
        <mat-error *ngIf="f.get('email')?.hasError('email')">Formato inválido.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Contraseña</mat-label>
        <input matInput type="password" formControlName="password" />
        <mat-error *ngIf="f.get('password')?.hasError('required')">La contraseña es obligatoria.</mat-error>
      </mat-form-field>

      <div class="full-width file-group">
        <button mat-raised-button type="button" color="primary" (click)="fileInput.click()">
          <mat-icon>image</mat-icon>
          Subir Foto de Perfil
        </button>

        <input #fileInput type="file" hidden (change)="onFileChange($any($event))" accept="image/*" />

        <mat-error *ngIf="f.get('imagenPerfil')?.hasError('required') && f.get('imagenPerfil')?.touched"
          style="font-size: 0.75rem; margin-top: 5px;">
          La imagen es obligatoria.
        </mat-error>

        <div class="preview" *ngIf="imagenPrevia">
          <img [src]="imagenPrevia" alt="Previsualización perfil" />
        </div>
      </div>

      <mat-slide-toggle color="warn" [checked]="!captchaEnabled" (change)="toggleCaptcha()">

        <span style="color: #ffffff !important; opacity: 1; font-weight: 500;">
          Desactivar Captcha (Modo Pruebas)
        </span>
      </mat-slide-toggle>

      <div class="captcha-wrapper" style="margin: 1rem 0;" *ngIf="captchaEnabled">
        <ngx-recaptcha2 formControlName="recaptcha" [siteKey]="siteKey" (success)="onCaptchaValid(true)"
          (expire)="registroForm.get('recaptcha')?.reset(); onCaptchaValid(false)" (error)="onCaptchaValid(false)">
        </ngx-recaptcha2>

        <mat-error *ngIf="f.get('recaptcha')?.invalid && f.get('recaptcha')?.touched">
          Debes completar el captcha.
        </mat-error>

        <div *ngIf="registroForm.get('recaptcha')?.touched && !captchaValido"
          style="color: #f44336; font-size: 0.8rem; margin-top: 5px;">
          El captcha expiró o es inválido.
        </div>
      </div>

      <div class="actions">
        <button mat-raised-button color="accent" class="full-width btn-submit" type="submit"
          [disabled]="f.invalid || (captchaEnabled && !captchaValido) || loading">
          <mat-spinner diameter="20" *ngIf="loading"></mat-spinner>
          <span *ngIf="!loading">Registrarse</span>
        </button>
      </div>

    </form>
  </mat-card-content>
</mat-card>

<app-fab-bienvenida></app-fab-bienvenida>