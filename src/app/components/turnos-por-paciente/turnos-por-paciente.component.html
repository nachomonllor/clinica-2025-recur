<section class="pagina-informe">

    <header class="barra-superior">
        <button mat-flat-button color="primary" routerLink="/seleccion-estadisticas">
            <mat-icon>arrow_back</mat-icon> Volver
        </button>
        <h1 class="titulo">Historial Clínico por Paciente</h1>
    </header>

    <!-- FILTRO DE SELECCIÓN -->
    <mat-card class="filtro-card">
        <form [formGroup]="filtroForm" (ngSubmit)="buscarHistorial()" class="form-inline">

            <mat-form-field appearance="outline" class="selector-paciente">
                <mat-label>Seleccionar Paciente</mat-label>
                <mat-select formControlName="pacienteId" (selectionChange)="buscarHistorial()">
                    <mat-option *ngFor="let p of pacientes" [value]="p.id">
                        <div class="option-row">
                            <img [src]="p.imagen_perfil_1 || 'assets/avatars/default.png'" class="avatar-mini"
                                alt="avatar">
                            <span>{{ p.apellido  | capitalizarNombre }}, {{ p.nombre   | capitalizarNombre }} (DNI: {{ p.dni }})</span>
                        </div>
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <button mat-stroked-button color="warn" type="button" (click)="limpiar()" *ngIf="pacienteSeleccionado">
                <mat-icon>clear</mat-icon> Limpiar
            </button>
        </form>
    </mat-card>

    <!-- RESULTADOS -->
    <div class="resultados-container" *ngIf="pacienteSeleccionado">

        <!-- Perfil Resumido del Paciente -->
        <div class="paciente-info glass">
            <img [src]="pacienteSeleccionado.imagen_perfil_1" class="avatar-grande" alt="paciente">
            <div class="datos">
                <h2> {{ pacienteSeleccionado.nombre | capitalizarNombre }} {{ pacienteSeleccionado.apellido | capitalizarNombre }}</h2>
                <p>DNI: {{ pacienteSeleccionado.dni }}</p>
                <p class="total-turnos">{{ turnos.length }} turnos registrados</p>
            </div>
        </div>

        <!-- Lista de Turnos -->
        <div class="lista-turnos" *ngIf="!buscandoTurnos; else loadingTpl">

            <div class="turno-item glass" *ngFor="let t of turnos">
                <div class="turno-header">
                    <div class="fecha-hora">
                        <span class="fecha">{{ t.fecha | date:'dd/MM/yyyy' }}</span>
                        <span class="hora">{{ t.hora }} hs</span>
                    </div>
                    <span class="estado-badge" [appStatusBadge]="t.estado">
                        {{ t.estado | statusLabel }}
                    </span>
                </div>

                <div class="turno-body">
                    <p><strong>Especialidad:</strong> {{ t.especialidad }}</p>
                    <p><strong>Profesional:</strong> {{ t.especialista }}</p>
                    <p *ngIf="t.resena" class="resena">
                        <em>"{{ t.resena }}"</em>
                    </p>
                </div>
            </div>

            <div class="empty-state" *ngIf="turnos.length === 0">
                <mat-icon>event_busy</mat-icon>
                <p>Este paciente no tiene historial de turnos.</p>
            </div>

        </div>

        <ng-template #loadingTpl>
            <div class="loading">
                <mat-spinner diameter="50"></mat-spinner>
                <p>Cargando historial...</p>
            </div>
        </ng-template>

    </div>

</section>