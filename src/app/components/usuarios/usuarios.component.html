<div class="page">

    <!-- img class="bg-img" src="assets/medical.jpg" alt="" loading="lazy" aria-hidden="true" / -->

    <!-- Header / Filtros -->
    <header class="header glass">
        <div class="brand">
            <div class="brand-logo">üè•</div>
            <div class="brand-text">
                <strong>Cl√≠nica Monllor</strong>
                <small>Usuarios</small>
            </div>
        </div>

        <div class="filters">
            <div class="search glass">
                <svg class="icon" viewBox="0 0 20 20" aria-hidden="true">
                    <path
                        d="M12.9 14.32a7 7 0 1 1 1.41-1.41l3.9 3.9a1 1 0 1 1-1.41 1.41l-3.9-3.9zM14 8a6 6 0 1 0-12 0 6 6 0 0 0 12 0z" />
                </svg>
                <input type="search" placeholder="Buscar por nombre, email, obra social o especialidad..."
                    [(ngModel)]="search" />
            </div>

            <div class="chips">
                <button class="chip" [class.active]="filtroRol === 'todos'" (click)="filtroRol = 'todos'">
                    Todos
                </button>
                <button class="chip" [class.active]="filtroRol === 'especialista'" (click)="filtroRol = 'especialista'">
                    Especialistas
                </button>
                <button class="chip" [class.active]="filtroRol === 'paciente'" (click)="filtroRol = 'paciente'">
                    Pacientes
                </button>
            </div>

            <label class="only-enabled">
                <input type="checkbox" [(ngModel)]="soloHabilitados" />
                <span>Solo habilitados</span>
            </label>
        </div>
    </header>

    <!-- Grilla de tarjetas -->
    <section class="grid" [@listStagger]>
        <article class="user-card" [@cardInOut] *ngFor="let u of filtered; trackBy: trackById"
            [ngClass]="[u.color, u.rol === 'paciente' ? 'card-lg' : 'card-sm']">
            <!-- Cinta de color superior -->
            <div class="accent"></div>

            <!-- Cabecera -->
            <div class="card-header">
                <div class="avatar" [class.has-img]="u.avatarUrl">
                    <img *ngIf="u.avatarUrl" [src]="u.avatarUrl" [alt]="u.nombre + ' ' + u.apellido" />
                    <span *ngIf="!u.avatarUrl">{{ initials(u) }}</span>
                </div>

                <div class="title">
                    <h3>{{ u.nombre }} {{ u.apellido }}</h3>
                    <div class="sub">
                        <span class="role">{{ rolChip(u) }}</span>
                        <span class="dot" *ngIf="u.edad !== undefined"></span>
                        <span *ngIf="u.edad !== undefined">{{ u.edad }} a√±os</span>
                    </div>
                </div>

                <span class="status" [@statusChanged]="u.habilitado">
                    {{ u.habilitado ? 'HABILITADO' : 'DESHABILITADO' }}
                </span>
            </div>

            <!-- Cuerpo -->
            <div class="card-body" [ngClass]="{'is-paciente': u.rol === 'paciente'}">
                <div class="info">
                    <div class="info-row">
                        <!-- <span class="label">Email</span>
                        <span class="value">{{ u.email }}</span> -->


                        <span class="label">Email</span>
                        <a class="value email" [href]="'mailto:' + u.email">{{ u.email }}</a>


                    </div>

                    <div class="info-row" *ngIf="u.dni">
                        <span class="label">DNI</span>
                        <span class="value">{{ u.dni }}</span>
                    </div>

                    <div class="info-row" *ngIf="u.rol === 'paciente' && u.obraSocial">
                        <span class="label">Obra social</span>
                        <span class="value tag">{{ u.obraSocial }}</span>
                    </div>

                    <div class="info-row" *ngIf="u.rol === 'especialista' && u.especialidades?.length">
                        <span class="label">Especialidades</span>
                        <span class="chips-line">
                            <span class="chip sm" *ngFor="let e of u.especialidades">{{ e }}</span>
                        </span>
                    </div>
                </div>

                <!-- Acciones -->
                <div class="actions" *ngIf="u.rol === 'paciente'; else accionesEspecialista">
                    <button class="btn primary ripple" (click)="verHistoria(u)">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M4 6a2 2 0 012-2h8l6 6v10a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 4v4h4" />
                        </svg>
                        Ver historia cl√≠nica
                    </button>
                    <button class="btn ghost ripple" (click)="descargarTurnos(u)">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 3v12m0 0l-4-4m4 4l4-4M5 21h14" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                        Descargar turnos
                    </button>
                </div>

                <ng-template #accionesEspecialista>
                    <div class="actions">
                        <button class="btn danger ripple" (click)="toggleHabilitado(u)"
                            [attr.aria-pressed]="!u.habilitado">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            {{ u.habilitado ? 'Deshabilitar' : 'Habilitar' }}
                        </button>
                    </div>
                </ng-template>
            </div>
        </article>
    </section>
</div>






<!-- <section class="usuarios">
    <header class="header">
        <h1>Usuarios</h1>

        <div class="actions">
            <div class="buscador">
                input type="search" [value]="searchTerm" (input)="setSearch(($event.target as HTMLInputElement).value)"
                    placeholder="Buscar por nombre, DNI, mail o especialidad" aria-label="Buscar usuarios" 

                <input type="search" #q [value]="searchTerm" (input)="setSearch(q.value)">

            </div>

            <button class="btn secondary" (click)="exportar()" [disabled]="(cargando$ | async)">
                Exportar
            </button>

            <button class="btn primary" (click)="onCrearUsuario()">Nuevo usuario</button>
        </div>
    </header>

    Filtros 
    <div class="filters">
        <div class="group">
            <span class="label">Rol</span>
            <button class="pill" [class.active]="(rolFilter$ | async) === 'todos'" (click)="setRol('todos')">
                Todos
            </button>
            <button class="pill" [class.active]="(rolFilter$ | async) === 'paciente'" (click)="setRol('paciente')">
                Pacientes
            </button>
            <button class="pill" [class.active]="(rolFilter$ | async) === 'especialista'"
                (click)="setRol('especialista')">
                Especialistas
            </button>
            <button class="pill" [class.active]="(rolFilter$ | async) === 'admin'" (click)="setRol('admin')">
                Admins
            </button>
        </div>

        <div class="group" *ngIf="(rolFilter$ | async) === 'especialista'">
            <span class="label">Estado</span>
            <button class="pill" [class.active]="(estadoFilter$ | async) === 'todos'" (click)="setEstado('todos')">
                Todos
            </button>
            <button class="pill" [class.active]="(estadoFilter$ | async) === 'habilitados'"
                (click)="setEstado('habilitados')">
                Habilitados
            </button>
            <button class="pill" [class.active]="(estadoFilter$ | async) === 'pendientes'"
                (click)="setEstado('pendientes')">
                Pendientes
            </button>
            <button class="pill" [class.active]="(estadoFilter$ | async) === 'inhabilitados'"
                (click)="setEstado('inhabilitados')">
                Inhabilitados
            </button>
        </div>
    </div>

Estado de error 
    <div class="estado" *ngIf="(error$ | async) as err">
        <div class="error">{{ err }}</div>
    </div>

    Tabla 
    <div class="tabla-wrapper" *ngIf="filtrados$ | async as usuarios; else loading">
        <table class="tabla">
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th>Rol</th>
                    <th>Especialidades / Obra Social</th>
                    <th>Estado</th>
                    <th>Email</th>
                    <th style="width: 1%;">Acciones</th>
                </tr>
            </thead>

            <tbody>
                <tr *ngFor="let u of usuarios; trackBy: trackById"
                    [class.inhabilitado]="u.rol === 'especialista' && u.habilitado === false">

                    <td class="usuario-cell">
                         cerrar el atributo y usar el campo correcto del VM 
                        <img [src]="u.avatarUrl || 'assets/avatar.svg'" (error)="onImgError($event)"
                            [alt]="u.apellido + ', ' + u.nombre" />

                        <div>
                            <div class="nombre">{{ u.apellido }}, {{ u.nombre }}</div>
                            <div class="dni-obra">
                                {{ u.dni }}
                                <ng-container *ngIf="u.rol === 'paciente' && u.obraSocial">
                                    ‚Ä¢ {{ u.obraSocial }}
                                </ng-container>
                            </div>
                        </div>
                    </td>

                    <td>
                        <span class="rol" [class.especialista]="u.rol === 'especialista'"
                            [class.admin]="u.rol === 'admin'">
                            {{ u.rol | titlecase }}
                        </span>
                    </td>

                    <td>
                        <ng-container *ngIf="u.rol === 'especialista'; else verif">
                            <label class="switch" title="Habilitar/Inhabilitar acceso">
                                 input type="checkbox" [checked]="u.habilitado"
                                    (change)="onToggleHabilitado(u, ($event.target as HTMLInputElement).checked)" 

                                <input type="checkbox" #chk [checked]="u.habilitado"
                                    (change)="onToggleHabilitado(u, chk.checked)" />



                                <span class="slider"></span>
                            </label>
                            <span class="estado-text" [class.ok]="u.habilitado" [class.warn]="!u.habilitado">
                                {{ u.habilitado ? 'Habilitado' : 'Inhabilitado' }}
                            </span>

                            <div class="secundario" *ngIf="!u.aprobado || !u.mailVerificado">
                                <button class="link" *ngIf="!u.aprobado" (click)="onAprobar(u)">Aprobar
                                    especialista</button>
                                <span class="badge warn" *ngIf="!u.mailVerificado">Mail no verificado</span>
                            </div>
                        </ng-container>

                        <ng-template #verif>
                            <span class="badge" [class.ok]="u.mailVerificado" [class.warn]="!u.mailVerificado">
                                {{ u.mailVerificado ? 'Mail verificado' : 'Mail no verificado' }}
                            </span>
                        </ng-template>
                    </td>

                    <td class="email">
                        <a [href]="'mailto:' + u.email">{{ u.email }}</a>
                    </td>

                    <td class="acciones">
                        <button class="btn icon" (click)="onVerDetalle(u)" title="Ver detalle">Detalle</button>
                        <button class="btn icon" *ngIf="u.rol === 'paciente'" (click)="onVerHistoriaClinica(u)"
                            title="Historia cl√≠nica">
                            H.C.
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="empty" *ngIf="usuarios.length === 0">No se encontraron usuarios con esos filtros.</div>
    </div>

    <ng-template #loading>
        <div class="loading">Cargando‚Ä¶</div>
    </ng-template>
</section> -->