<mat-card class="usuarios-container" appElevateOnHover>
  <mat-card-header>
    <mat-card-title>Gestión de usuarios</mat-card-title>
    <mat-card-subtitle>Solo visible para administradores</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content class="usuarios-layout">
    <section class="panel panel-listado">
      <div class="panel-actions">
        <mat-form-field appearance="outline" class="buscador">
          <mat-label>Buscar usuarios</mat-label>
          <input
            matInput
            #filtroInput
            [value]="filtroTexto"
            (input)="aplicarFiltro(filtroInput.value)"
            placeholder="Nombre, apellido, email o rol" />
          <button
            mat-icon-button
            matSuffix
            *ngIf="filtroInput.value"
            aria-label="Limpiar búsqueda"
            (click)="filtroInput.value=''; aplicarFiltro('')">
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>

        <div class="action-buttons">
          <button mat-stroked-button color="accent" (click)="descargarExcel()">
            <mat-icon>table_view</mat-icon>
            Descargar Excel general
          </button>
          <button mat-flat-button color="primary" (click)="crearUsuario()" *ngIf="!mostrarFormulario">
            <mat-icon>person_add</mat-icon>
            Crear usuario
          </button>
          <button mat-stroked-button color="warn" (click)="cancelarCreacion()" *ngIf="mostrarFormulario">
            <mat-icon>close</mat-icon>
            Cancelar alta
          </button>
        </div>
      </div>

      <div class="usuario-grid" *ngIf="usuariosFiltrados.length; else sinUsuarios">
        <button
          type="button"
          class="usuario-card"
          *ngFor="let usuario of usuariosFiltrados; trackBy: trackUsuario"
          [class.activo]="usuarioSeleccionado?.id === usuario.id"
          (click)="seleccionarUsuario(usuario)"
          matTooltip="{{ usuario.nombre }} {{ usuario.apellido }}">
          <div class="avatar">
            <img
              [src]="usuario.avatar_url || 'assets/img/default-avatar.png'"
              [alt]="usuario.nombre || 'Usuario sin nombre'"
              loading="lazy" />
          </div>
          <div class="texto">
            <span class="nombre">{{ usuario.apellido }} {{ usuario.nombre }}</span>
            <span class="meta">{{ usuario.email || 'Sin email cargado' }}</span>
            <span class="meta meta-small">Rol: {{ usuario.rol | roleLabel }}</span>
          </div>
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    </section>

    <section class="panel panel-detalle" *ngIf="usuarioSeleccionado as seleccionado; else sinSeleccion">
      <div class="detalle-encabezado">
        <div class="avatar-principal">
          <img
            [src]="seleccionado.avatar_url || 'assets/img/default-avatar.png'"
            [alt]="seleccionado.nombre || 'Avatar de usuario'"
            loading="lazy" />
        </div>
        <div class="detalle-titulos">
          <h3>{{ seleccionado.apellido }} {{ seleccionado.nombre }}</h3>
          <div class="chips">
            <mat-chip [color]="getRolColor(seleccionado.rol)" selected>
              {{ seleccionado.rol | roleLabel }}
            </mat-chip>
            <span
              *ngIf="seleccionado.rol === 'especialista'"
              [appStatusBadge]="seleccionado.aprobado ? 'realizado' : 'pendiente'">
              {{ seleccionado.aprobado ? 'Aprobado' : 'Pendiente' }}
            </span>
          </div>
          <p class="meta">
            <mat-icon>mail</mat-icon>
            {{ seleccionado.email || 'Sin email cargado' }}
          </p>
          <p class="meta" *ngIf="seleccionado.dni">
            <mat-icon>badge</mat-icon>
            DNI: {{ seleccionado.dni }}
          </p>
          <p class="meta" *ngIf="seleccionado.rol === 'paciente' && seleccionado.obra_social">
            <mat-icon>health_and_safety</mat-icon>
            Obra social: {{ seleccionado.obra_social }}
          </p>
          <p class="meta" *ngIf="seleccionado.fecha_nacimiento">
            <mat-icon>cake</mat-icon>
            Nacimiento: {{ fechaLarga(seleccionado.fecha_nacimiento) }}
          </p>
          <p class="meta" *ngIf="seleccionado.created_at">
            <mat-icon>event</mat-icon>
            Alta en sistema: {{ fechaLarga(seleccionado.created_at) }}
          </p>
        </div>
      </div>

      <div class="detalle-acciones">
        <button mat-stroked-button color="primary" (click)="descargarTurnosUsuario(seleccionado)">
          <mat-icon>download</mat-icon>
          Turnos en Excel
        </button>
        <button
          mat-stroked-button
          color="accent"
          *ngIf="seleccionado.rol === 'paciente'"
          (click)="verHistoriaClinica(seleccionado.id, seleccionado.nombre + ' ' + seleccionado.apellido)">
          <mat-icon>medical_services</mat-icon>
          Historia clínica
        </button>
        <button
          mat-flat-button
          color="warn"
          *ngIf="seleccionado.rol === 'especialista'"
          (click)="toggleAprobacion(seleccionado)">
          <mat-icon>{{ seleccionado.aprobado ? 'block' : 'check_circle' }}</mat-icon>
          {{ seleccionado.aprobado ? 'Inhabilitar' : 'Habilitar' }}
        </button>
      </div>

      <div class="detalle-turnos">
        <h4>Turnos asociados</h4>

        <div class="detalle-cargando" *ngIf="cargandoTurnos">
          <mat-progress-spinner diameter="36" mode="indeterminate"></mat-progress-spinner>
          <span>Cargando turnos...</span>
        </div>

        <ng-container *ngIf="!cargandoTurnos">
          <div class="turno-lista" *ngIf="turnosUsuario.length; else sinTurnos">
            <article class="turno-item" *ngFor="let turno of turnosUsuario; trackBy: trackTurno">
              <div class="turno-info">
                <span class="especialidad">{{ turno.especialidad }}</span>
                <span class="fecha">{{ turno.fechaTexto }}</span>
              </div>
              <div class="turno-meta">
                <span class="contraparte">{{ turno.contraparte }}</span>
                <span class="estado" [appStatusBadge]="turno.estado">{{ turno.estado | titlecase }}</span>
              </div>
            </article>
          </div>
        </ng-container>
      </div>
    </section>

    <ng-template #sinUsuarios>
      <section class="panel panel-placeholder">
        <mat-icon>people_outline</mat-icon>
        <p>No encontramos usuarios con ese criterio.</p>
        <button mat-button color="primary" (click)="aplicarFiltro('')">Ver todos</button>
      </section>
    </ng-template>

    <ng-template #sinSeleccion>
      <section class="panel panel-placeholder">
        <mat-icon>person_search</mat-icon>
        <h3>Seleccioná un usuario</h3>
        <p>Podrás revisar su información, descargar turnos y ejecutar acciones rápidas.</p>
      </section>
    </ng-template>

    <ng-template #sinTurnos>
      <p class="sin-datos">Este usuario todavía no registra turnos.</p>
    </ng-template>
  </mat-card-content>
</mat-card>

<mat-card *ngIf="mostrarFormulario" class="form-card">
  <mat-card-title>Crear nuevo usuario</mat-card-title>
  <form [formGroup]="formularioUsuario" (ngSubmit)="guardarUsuario()">
    <div class="form-grid">
      <mat-form-field appearance="outline">
        <mat-label>Rol</mat-label>
        <mat-select formControlName="rol">
          <mat-option value="paciente">Paciente</mat-option>
          <mat-option value="especialista">Especialista</mat-option>
          <mat-option value="admin">Administrador</mat-option>
        </mat-select>
        <mat-error *ngIf="formularioUsuario.get('rol')?.hasError('required')">El rol es obligatorio.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="nombre" />
        <mat-error *ngIf="formularioUsuario.get('nombre')?.hasError('required')">El nombre es obligatorio.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Apellido</mat-label>
        <input matInput formControlName="apellido" />
        <mat-error *ngIf="formularioUsuario.get('apellido')?.hasError('required')">El apellido es obligatorio.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Fecha de nacimiento</mat-label>
        <input
          matInput
          type="date"
          formControlName="fechaNacimiento"
          [min]="minDateISO"
          [max]="maxDateISO" />
        <mat-error *ngIf="formularioUsuario.get('fechaNacimiento')?.hasError('required')">
          La fecha es obligatoria.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>DNI</mat-label>
        <input matInput formControlName="dni" />
        <mat-error *ngIf="formularioUsuario.get('dni')?.hasError('required')">El DNI es obligatorio.</mat-error>
      </mat-form-field>

      <mat-form-field
        appearance="outline"
        *ngIf="formularioUsuario.get('rol')?.value === 'paciente'">
        <mat-label>Obra social</mat-label>
        <input matInput formControlName="obraSocial" />
        <mat-error *ngIf="formularioUsuario.get('obraSocial')?.hasError('required')">
          La obra social es obligatoria para pacientes.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Email</mat-label>
        <input matInput type="email" formControlName="email" />
        <mat-error *ngIf="formularioUsuario.get('email')?.hasError('required')">El email es obligatorio.</mat-error>
        <mat-error *ngIf="formularioUsuario.get('email')?.hasError('email')">Formato inválido.</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Contraseña</mat-label>
        <input matInput type="password" formControlName="password" />
        <mat-error *ngIf="formularioUsuario.get('password')?.hasError('required')">
          La contraseña es obligatoria.
        </mat-error>
        <mat-error *ngIf="formularioUsuario.get('password')?.hasError('minlength')">
          Mínimo 6 caracteres.
        </mat-error>
      </mat-form-field>
    </div>

    <div class="file-group">
      <button mat-raised-button type="button" color="primary" (click)="fileInput.click()">
        Seleccionar imagen
      </button>
      <input #fileInput type="file" hidden (change)="onFileChange($event)" accept="image/*" />
      <mat-error
        *ngIf="formularioUsuario.get('imagenPerfil')?.hasError('required') && formularioUsuario.get('imagenPerfil')?.touched">
        La imagen es obligatoria.
      </mat-error>
      <div class="preview" *ngIf="imagenPrevia">
        <img [src]="imagenPrevia" alt="Previsualización" />
      </div>
    </div>

    <div class="form-actions">
      <button mat-button type="button" (click)="cancelarCreacion()">Cancelar</button>
      <button mat-raised-button color="primary" type="submit" [disabled]="formularioUsuario.invalid">
        Guardar usuario
      </button>
    </div>
  </form>
</mat-card>

