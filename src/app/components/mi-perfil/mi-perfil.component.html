<div class="profile-page" [@pageIn] *ngIf="perfil as p">

  <div class="hero-content glass">

    <div class="hero-left">
      <div class="avatar" [class.has-img]="!!p.avatar_url">
        <img *ngIf="p.avatar_url" [src]="p.avatar_url" [alt]="nombreCompleto" />
        <span *ngIf="!p.avatar_url">{{ avatarIniciales }}</span>
      </div>
      <div class="title">
        <h1>{{ nombreCompleto }}</h1>
        <div class="sub">
          <span class="chip role">{{ rolUpper }}</span>
          <span class="dot" *ngIf="p.fecha_nacimiento"></span>
          <span *ngIf="p.fecha_nacimiento">{{ calcularEdad(p.fecha_nacimiento) }}</span>
        </div>
      </div>
    </div>

    <div class="hero-right">
      <div class="hero-actions">
        <button class="btn primary ripple" *ngIf="esPaciente && historiasFiltradas.length" (click)="descargarPDF()">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M12 3v12m0 0l-4-4m4 4l4-4M5 21h14" />
          </svg>
          Descargar historia
        </button>
        <!-- <a class="btn ghost ripple" *ngIf="esEspecialista" (click)="scrollToHistoria()">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M8 7h8M7 11h10M6 15h12" />
          </svg>
          Ver historia
        </a> -->
      </div>
    </div>
  </div>

  <section class="content-grid">

    <article class="panel">
      <header class="panel-h">
        <h2>Información Personal</h2>
      </header>
      <div class="panel-b info">
        <div class="info-row"><span class="label">Nombre</span><span class="value">{{ nombreCompleto }}</span></div>
        <div class="info-row"><span class="label">DNI</span><span class="value">{{ p.dni }}</span></div>
        <div class="info-row" *ngIf="p.fecha_nacimiento">
          <span class="label">Fecha de nacimiento</span>
          <span class="value">{{ p.fecha_nacimiento | date:'dd/MM/yyyy' }}</span>
        </div>
        <div class="info-row" *ngIf="p.obra_social">
          <span class="label">Obra Social</span>
          <span class="value tag">{{ p.obra_social }}</span>
        </div>

        <div class="info-row" *ngIf="esEspecialista && p.especialidades?.length">
          <span class="label">Especialidades</span>
          <span class="value chips-line">
            <span class="chip sm" *ngFor="let esp of p.especialidades">{{ esp }}</span>
          </span>
        </div>
      </div>
    </article>

    <article class="panel">
      <header class="panel-h">
        <h2>Contacto</h2>
      </header>
      <div class="panel-b info">
        <div class="info-row">
          <span class="label">Email</span>
          <a class="value email" [href]="'mailto:' + p.email">{{ p.email }}</a>
        </div>
      </div>
    </article>

    <article class="panel span-2" *ngIf="esEspecialista && formularioHorarios">
      <header class="panel-h">
        <h2>Mis horarios</h2>
      </header>
      <div class="panel-b">

        <form [formGroup]="formularioHorarios" (ngSubmit)="guardarHorarios()">
          <div formArrayName="horarios" class="horarios-grid">

            <mat-card *ngFor="let grupo of horariosArray.controls; let i = index" [formGroupName]="i"
              class="horario-card glass">

              <div class="horario-h">
                <h3>{{ getHorarioGroup(i).get('especialidad')?.value }}</h3>
              </div>

              <!-- <div class="horario-b">
                <p class="instruccion"
                  style="font-size: 0.9rem; color: #aab; margin-bottom: 1.5rem; text-align: center;">
                  Activa los días laborales y arrastra los círculos para definir tu horario de entrada y salida.
                </p>

                <div class="lista-dias-slider" *ngIf="disponibilidad[i]">

                  <div class="dia-row" *ngFor="let dia of disponibilidad[i]">

                    <mat-checkbox [(ngModel)]="dia.activo" [ngModelOptions]="{standalone: true}" class="check-dia">
                      {{ dia.nombre }}
                    </mat-checkbox>

                    <div class="slider-wrapper" *ngIf="dia.activo"
                      style="flex: 1; display: flex; align-items: center; gap: 15px;">

                      <span class="hora-label" style="font-weight: bold; color: #fbbf24; min-width: 45px;">
                        {{ formatLabel(dia.inicio) }}
                      </span>

                      <mat-slider min="8" [max]="dia.nombre === 'Sábado' ? 14 : 19" step="0.25" discrete
                        [displayWith]="formatLabel" style="flex: 1; min-width: 150px;">

                        <input matSliderStartThumb [(ngModel)]="dia.inicio" [ngModelOptions]="{standalone: true}">
                        <input matSliderEndThumb [(ngModel)]="dia.fin" [ngModelOptions]="{standalone: true}">
                      </mat-slider>

                      <span class="hora-label" style="font-weight: bold; color: #fbbf24; min-width: 45px;">
                        {{ formatLabel(dia.fin) }}
                      </span>
                    </div>

                    <div class="mensaje-inactivo" *ngIf="!dia.activo"
                      style="flex: 1; color: #666; font-style: italic; padding-left: 20px;">
                      No laborable
                    </div>

                  </div>
                </div>
              </div> -->

                  <div class="horario-b">
                <p class="instruccion" style="font-size: 0.9rem; color: #aab; margin-bottom: 1.5rem;">
                  Configura tus horarios laborales arrastrando los círculos.
                </p>

                <div class="layout-edicion-resumen">
                  
                  <div class="lista-dias-slider">
                    <div class="dia-row" *ngFor="let dia of disponibilidad[i]">
                      
                      <mat-checkbox [(ngModel)]="dia.activo" [ngModelOptions]="{standalone: true}" class="check-dia">
                        {{ dia.nombre }}
                      </mat-checkbox>

                      <div class="slider-wrapper" *ngIf="dia.activo">
                        <span class="hora-label">{{ formatLabel(dia.inicio) }}</span>
                        
                        <mat-slider min="8" [max]="dia.nombre === 'Sábado' ? 14 : 19" step="0.25" discrete 
                                    [displayWith]="formatLabel">
                          <input matSliderStartThumb [(ngModel)]="dia.inicio" [ngModelOptions]="{standalone: true}">
                          <input matSliderEndThumb [(ngModel)]="dia.fin" [ngModelOptions]="{standalone: true}">
                        </mat-slider>
                        
                        <span class="hora-label">{{ formatLabel(dia.fin) }}</span>
                      </div>

                      <div class="mensaje-inactivo" *ngIf="!dia.activo">
                        No laborable
                      </div>
                    </div>
                  </div>

                  <div class="resumen-semanal glass">
                    <h4>Resumen de Atención</h4>
                    <ul class="lista-resumen">
                      <ng-container *ngFor="let dia of disponibilidad[i]">
                        <li *ngIf="dia.activo" class="item-resumen">
                          <span class="dia-badge">{{ dia.nombre.substring(0, 3) | uppercase }}</span>
                          <span class="hora-rango">
                            {{ formatLabel(dia.inicio) }} a {{ formatLabel(dia.fin) }} hs
                          </span>
                        </li>
                      </ng-container>
                      
                      <li *ngIf="!tieneDiasActivos(disponibilidad[i])" class="sin-horarios">
                        Sin horarios definidos
                      </li>
                    </ul>
                  </div>

                </div>
              </div>
              

            </mat-card>

          </div>

          <div class="actions">
            <button mat-raised-button color="primary" type="submit" [disabled]="loading">
              {{ loading ? 'Guardando...' : 'Guardar Horarios' }}
            </button>
          </div>
        </form>
      </div>
    </article>

    <article class="panel span-2" id="historiaClinica" *ngIf="esPaciente">
      <header class="panel-h">
        <h2>Mi Historia Clínica</h2>
        <div class="right">
          <mat-form-field appearance="outline" class="selector-profesional" *ngIf="especialistasDisponibles.length">
            <mat-label>Filtrar por profesional</mat-label>
            <mat-select [value]="especialistaSeleccionado" (selectionChange)="seleccionarEspecialista($event.value)">
              <mat-option value="todos">Todos los profesionales</mat-option>
              <mat-option *ngFor="let e of especialistasDisponibles" [value]="e.id">{{ e.nombre | capitalizarNombre
                }}</mat-option>
            </mat-select>
          </mat-form-field>
          <button mat-raised-button color="primary" (click)="descargarPDF()"
            [disabled]="historiasFiltradas.length === 0">
            <mat-icon>picture_as_pdf</mat-icon> Descargar PDF
          </button>
        </div>
      </header>

      <div class="panel-b">
        <p *ngIf="historiasClinicas.length === 0" class="muted">No hay historias clínicas registradas.</p>

        <mat-accordion *ngIf="historiasFiltradas.length > 0; else noFiltro" class="hist-accordion">
          <mat-expansion-panel *ngFor="let historia of historiasFiltradas">
            <mat-expansion-panel-header>
              <mat-panel-title>{{ formatearFecha(historia.created_at) }} — {{ historia.especialistaNombre
                }}</mat-panel-title>
            </mat-expansion-panel-header>

            <div class="historia-content">
              <div class="historia-grid">
                <div class="historia-item"><strong>Fecha de Atención:</strong> {{ historia.fechaAtencion }}</div>
                <div class="historia-item"><strong>Especialista:</strong> {{ historia.especialistaNombre }}</div>
                <div class="historia-item"><strong>Altura:</strong> {{ historia.altura }} cm</div>
                <div class="historia-item"><strong>Peso:</strong> {{ historia.peso }} kg</div>
                <div class="historia-item"><strong>Temperatura:</strong> {{ historia.temperatura }} °C</div>
                <div class="historia-item"><strong>Presión:</strong> {{ historia.presion }}</div>
              </div>

              <div *ngIf="historia.datos_dinamicos?.length" class="datos-dinamicos">
                <h4>Indicadores adicionales</h4>
                <ul>
                  <li *ngFor="let dato of historia.datos_dinamicos">{{ formatDatoDinamico(dato) }}</li>
                </ul>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-accordion>

        <ng-template #noFiltro>
          <p class="muted">No encontramos historias clínicas para el profesional seleccionado.</p>
        </ng-template>
      </div>
    </article>

  </section>
</div>


<!-- <div class="profile-page" [@pageIn] *ngIf="perfil as p">

  <div class="hero-content glass">

    <div class="hero-left">
      <div class="avatar" [class.has-img]="!!p.avatar_url">
        <img *ngIf="p.avatar_url" [src]="p.avatar_url" [alt]="nombreCompleto" />
        <span *ngIf="!p.avatar_url">{{ avatarIniciales }}</span>
      </div>
      <div class="title">
        <h1>{{ nombreCompleto }}</h1>
        <div class="sub">
          <span class="chip role">{{ rolUpper }}</span>
          <span class="dot" *ngIf="p.fecha_nacimiento"></span>
          <span *ngIf="p.fecha_nacimiento">{{ calcularEdad(p.fecha_nacimiento) }}</span>
        </div>
      </div>
    </div>

    <div class="hero-right">
      <div class="hero-actions">
        <button class="btn primary ripple" *ngIf="esPaciente && historiasFiltradas.length" (click)="descargarPDF()">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M12 3v12m0 0l-4-4m4 4l4-4M5 21h14" />
          </svg>
          Descargar historia
        </button>
        <a class="btn ghost ripple" *ngIf="esEspecialista" (click)="scrollToHistoria()">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M8 7h8M7 11h10M6 15h12" />
          </svg>
          Ver historia
        </a>
      </div>
    </div>
  </div>

  <section class="content-grid">

    <article class="panel">
      <header class="panel-h">
        <h2>Información Personal</h2>
      </header>
      <div class="panel-b info">
        <div class="info-row"><span class="label">Nombre</span><span class="value">{{ nombreCompleto }}</span></div>
        <div class="info-row"><span class="label">DNI</span><span class="value">{{ p.dni }}</span></div>
        <div class="info-row" *ngIf="p.fecha_nacimiento">
          <span class="label">Fecha de nacimiento</span>
          <span class="value">{{ p.fecha_nacimiento | date:'dd/MM/yyyy' }}</span>
        </div>
        <div class="info-row" *ngIf="p.obra_social">
          <span class="label">Obra Social</span>
          <span class="value tag">{{ p.obra_social }}</span>
        </div>

        <div class="info-row" *ngIf="esEspecialista && p.especialidades?.length">
          <span class="label">Especialidades</span>
          <span class="value chips-line">
            <span class="chip sm" *ngFor="let esp of p.especialidades">{{ esp }}</span>
          </span>
        </div>
      </div>
    </article>

    <article class="panel">
      <header class="panel-h">
        <h2>Contacto</h2>
      </header>
      <div class="panel-b info">
        <div class="info-row">
          <span class="label">Email</span>
          <a class="value email" [href]="'mailto:' + p.email">{{ p.email }}</a>
        </div>
      </div>
    </article>

    <article class="panel span-2" *ngIf="esEspecialista && formularioHorarios">
      <header class="panel-h">
        <h2>Mis horarios</h2>
      </header>
      <div class="panel-b">

        <form [formGroup]="formularioHorarios" (ngSubmit)="guardarHorarios()">
          <div formArrayName="horarios" class="horarios-grid">

            <mat-card *ngFor="let grupo of horariosArray.controls; let i = index" [formGroupName]="i"
              class="horario-card glass">

              <div class="horario-h">
                <h3>{{ getHorarioGroup(i).get('especialidad')?.value }}</h3>
              </div>

              <div class="horario-b">
                <p class="instruccion"
                  style="font-size: 0.9rem; color: #aab; margin-bottom: 1.5rem; text-align: center;">
                  Activa los días laborales y arrastra los círculos para definir tu horario de entrada y salida.
                </p>

                <div class="lista-dias-slider" *ngIf="disponibilidad[i]">

                  <div class="dia-row" *ngFor="let dia of disponibilidad[i]">

                    <mat-checkbox [(ngModel)]="dia.activo" [ngModelOptions]="{standalone: true}" class="check-dia">
                      {{ dia.nombre }}
                    </mat-checkbox>

                    <div class="slider-wrapper" *ngIf="dia.activo"
                      style="flex: 1; display: flex; align-items: center; gap: 15px;">

                      <span class="hora-label" style="font-weight: bold; color: #fbbf24; min-width: 45px;">
                        {{ formatLabel(dia.inicio) }}
                      </span>

                      <mat-slider min="8" [max]="dia.nombre === 'Sábado' ? 14 : 19" step="0.25" discrete
                        [displayWith]="formatLabel" style="flex: 1; min-width: 150px;">

                        <input matSliderStartThumb [(ngModel)]="dia.inicio" [ngModelOptions]="{standalone: true}">
                        <input matSliderEndThumb [(ngModel)]="dia.fin" [ngModelOptions]="{standalone: true}">
                      </mat-slider>

                      <span class="hora-label" style="font-weight: bold; color: #fbbf24; min-width: 45px;">
                        {{ formatLabel(dia.fin) }}
                      </span>
                    </div>

                    <div class="mensaje-inactivo" *ngIf="!dia.activo"
                      style="flex: 1; color: #666; font-style: italic; padding-left: 20px;">
                      No laborable
                    </div>

                  </div>
                </div>
              </div>
            </mat-card>

          </div>

          <div class="actions">
            <button mat-raised-button color="primary" type="submit" [disabled]="loading">
              {{ loading ? 'Guardando...' : 'Guardar Horarios' }}
            </button>
          </div>
        </form>
      </div>
    </article>

    <article class="panel span-2" id="historiaClinica" *ngIf="esPaciente">
      <header class="panel-h">
        <h2>Mi Historia Clínica</h2>
        <div class="right">
          <mat-form-field appearance="outline" class="selector-profesional" *ngIf="especialistasDisponibles.length">
            <mat-label>Filtrar por profesional</mat-label>
            <mat-select [value]="especialistaSeleccionado" (selectionChange)="seleccionarEspecialista($event.value)">
              <mat-option value="todos">Todos los profesionales</mat-option>
              <mat-option *ngFor="let e of especialistasDisponibles" [value]="e.id">{{ e.nombre | capitalizarNombre
                }}</mat-option>
            </mat-select>
          </mat-form-field>
          <button mat-raised-button color="primary" (click)="descargarPDF()"
            [disabled]="historiasFiltradas.length === 0">
            <mat-icon>picture_as_pdf</mat-icon> Descargar PDF
          </button>
        </div>
      </header>

      <div class="panel-b">
        <p *ngIf="historiasClinicas.length === 0" class="muted">No hay historias clínicas registradas.</p>

        <mat-accordion *ngIf="historiasFiltradas.length > 0; else noFiltro" class="hist-accordion">
          <mat-expansion-panel *ngFor="let historia of historiasFiltradas">
            <mat-expansion-panel-header>
              <mat-panel-title>{{ formatearFecha(historia.created_at) }} — {{ historia.especialistaNombre
                }}</mat-panel-title>
            </mat-expansion-panel-header>

            <div class="historia-content">
              <div class="historia-grid">
                <div class="historia-item"><strong>Fecha de Atención:</strong> {{ historia.fechaAtencion }}</div>
                <div class="historia-item"><strong>Especialista:</strong> {{ historia.especialistaNombre }}</div>
                <div class="historia-item"><strong>Altura:</strong> {{ historia.altura }} cm</div>
                <div class="historia-item"><strong>Peso:</strong> {{ historia.peso }} kg</div>
                <div class="historia-item"><strong>Temperatura:</strong> {{ historia.temperatura }} °C</div>
                <div class="historia-item"><strong>Presión:</strong> {{ historia.presion }}</div>
              </div>

              <div *ngIf="historia.datos_dinamicos?.length" class="datos-dinamicos">
                <h4>Indicadores adicionales</h4>
                <ul>
                  <li *ngFor="let dato of historia.datos_dinamicos">{{ formatDatoDinamico(dato) }}</li>
                </ul>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-accordion>

        <ng-template #noFiltro>
          <p class="muted">No encontramos historias clínicas para el profesional seleccionado.</p>
        </ng-template>
      </div>
    </article>

  </section>
</div> -->